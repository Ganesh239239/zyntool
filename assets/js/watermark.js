let files=[];let previewImg=null;document.addEventListener('DOMContentLoaded',function(){document.getElementById('fileInput').addEventListener('change',function(e){files=Array.from(e.target.files);if(files.length){document.getElementById('toolOptions').classList.add('active');document.getElementById('previewArea').classList.add('active');const reader=new FileReader();reader.onload=function(e){previewImg=new Image();previewImg.onload=updatePreview;previewImg.src=e.target.result};reader.readAsDataURL(files[0])}});['wmText','position'].forEach(id=>{document.getElementById(id).addEventListener('input',updatePreview)});function updatePreview(){if(!previewImg)return;const canvas=document.getElementById('preview');const ctx=canvas.getContext('2d');canvas.width=previewImg.width;canvas.height=previewImg.height;ctx.drawImage(previewImg,0,0);const text=document.getElementById('wmText').value;const pos=document.getElementById('position').value;ctx.font='bold 40px Arial';ctx.fillStyle='rgba(255,255,255,0.7)';ctx.strokeStyle='rgba(0,0,0,0.5)';ctx.lineWidth=2;const w=ctx.measureText(text).width;const p=20;let x,y;if(pos==='br'){x=canvas.width-w-p;y=canvas.height-p}else if(pos==='bl'){x=p;y=canvas.height-p}else if(pos==='tr'){x=canvas.width-w-p;y=60}else{x=p;y=60}ctx.strokeText(text,x,y);ctx.fillText(text,x,y)}document.getElementById('wmBtn').addEventListener('click',function(){if(!files.length){alert('Select images');return}document.getElementById('loading').classList.add('active');let done=0;files.forEach((file,i)=>{const reader=new FileReader();reader.onload=function(e){const img=new Image();img.onload=function(){const canvas=document.createElement('canvas');const ctx=canvas.getContext('2d');canvas.width=img.width;canvas.height=img.height;ctx.drawImage(img,0,0);const text=document.getElementById('wmText').value;const pos=document.getElementById('position').value;ctx.font='bold 40px Arial';ctx.fillStyle='rgba(255,255,255,0.7)';ctx.strokeStyle='rgba(0,0,0,0.5)';ctx.lineWidth=2;const w=ctx.measureText(text).width;const p=20;let x,y;if(pos==='br'){x=canvas.width-w-p;y=canvas.height-p}else if(pos==='bl'){x=p;y=canvas.height-p}else if(pos==='tr'){x=canvas.width-w-p;y=60}else{x=p;y=60}ctx.strokeText(text,x,y);ctx.fillText(text,x,y);canvas.toBlob(function(blob){const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=file.name.replace(/\.[^/.]+$/,'')+'_watermarked.jpg';setTimeout(()=>{a.click();URL.revokeObjectURL(url)},i*200);done++;if(done===files.length){document.getElementById('loading').classList.remove('active');alert('Watermarked!')}},'image/jpeg',0.9)};img.src=e.target.result};reader.readAsDataURL(file)})})});