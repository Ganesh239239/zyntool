---
const { entry } = Astro.props;
---

<div id="compress-engine">
    <!-- VIEW 1: SELECT BUTTON (Like your image) -->
    <div id="uploadContainer" class="py-5">
        <div class="text-center">
            <button class="btn-select-images shadow-lg" onclick="document.getElementById('fileInput').click()">
                Select images
            </button>
            <p class="mt-3 text-muted">or drop images here</p>
            <input type="file" id="fileInput" hidden accept="image/*" multiple />
        </div>
    </div>

    <!-- VIEW 2: WORKSPACE (Like iLoveIMG Gallery) -->
    <div id="processingArea" style="display:none;" class="fade-in">
        <div class="row g-0 bg-white shadow-sm rounded-4 overflow-hidden border">
            <!-- Left: Gallery -->
            <div class="col-lg-8 bg-light p-4" style="min-height: 500px;">
                <div id="imageGrid" class="d-grid gap-3" style="grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));">
                    <!-- Thumbnails go here -->
                </div>
            </div>

            <!-- Right: Options Sidebar -->
            <div class="col-lg-4 border-start p-4 bg-white">
                <h4 class="fw-bold mb-4">Compress images</h4>
                <div class="alert alert-primary border-0 small mb-5">
                    All images will be compressed with the best quality and filesize ratio.
                </div>
                
                <div class="d-grid mt-auto">
                    <button id="btnAction" class="btn btn-primary btn-lg fw-bold py-3 rounded-3">
                        Compress IMAGES <i class="fa-solid fa-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW 3: SUCCESS -->
    <div id="resultArea" style="display:none;" class="text-center py-5 fade-in">
        <h2 class="fw-bold mb-4">Your IMAGES have been compressed!</h2>
        <a id="downloadBtn" class="btn btn-primary btn-lg px-5 py-3 rounded-3 fw-bold shadow-lg mb-4">
            Download compressed IMAGES
        </a>
        <div id="statsLabel" class="text-muted small fw-bold"></div>
        <br/>
        <button class="btn btn-link text-decoration-none mt-3" onclick="location.reload()">Process another batch</button>
    </div>
</div>

<style>
    /* THE SELECT BUTTON */
    .btn-select-images {
        background-color: #4b8df8;
        color: white;
        border: none;
        padding: 25px 80px;
        font-size: 2.2rem;
        font-weight: 700;
        border-radius: 12px;
        transition: 0.2s;
    }
    .btn-select-images:hover { background-color: #3b7dec; transform: scale(1.02); }

    /* Thumbnails */
    .img-thumb-card { background: white; padding: 8px; border-radius: 8px; border: 1px solid #ddd; text-align: center; }
    .img-thumb-card img { width: 100%; height: 100px; object-fit: contain; }
    .img-thumb-card span { font-size: 0.65rem; display: block; margin-top: 5px; color: #666; }

    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>

<script is:inline>
    const fileInput = document.getElementById('fileInput');
    const uploadContainer = document.getElementById('uploadContainer');
    const processingArea = document.getElementById('processingArea');
    const imageGrid = document.getElementById('imageGrid');
    const btnAction = document.getElementById('btnAction');
    const resultArea = document.getElementById('resultArea');

    let queue = [];

    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        uploadContainer.style.display = 'none';
        processingArea.style.display = 'block';

        files.forEach(file => {
            queue.push(file);
            const div = document.createElement('div');
            div.className = 'img-thumb-card';
            div.innerHTML = `<img src="${URL.createObjectURL(file)}"><span>${file.name}</span>`;
            imageGrid.appendChild(div);
        });
    });

    btnAction.addEventListener('click', async () => {
        btnAction.disabled = true;
        btnAction.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Compressing...';

        let totalOld = 0;
        let totalNew = 0;
        const zip = new JSZip();

        for (const file of queue) {
            totalOld += file.size;
            try {
                const blob = await imageCompression(file, { maxSizeMB: 1, initialQuality: 0.7 });
                totalNew += blob.size;
                zip.file(`compressed-${file.name}`, blob);
            } catch (err) { totalNew += file.size; }
        }

        const zipBlob = await zip.generateAsync({ type: "blob" });
        const url = URL.createObjectURL(zipBlob);
        
        document.getElementById('statsLabel').innerText = `Saved ${Math.round(((totalOld-totalNew)/totalOld)*100)}% of file size.`;
        document.getElementById('downloadBtn').href = url;
        document.getElementById('downloadBtn').download = "zyntool-images.zip";

        processingArea.style.display = 'none';
        resultArea.style.display = 'block';
    });
</script>
