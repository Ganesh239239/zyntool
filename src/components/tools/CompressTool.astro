---
const { entry } = Astro.props;
---

<div id="compress-engine">
    <!-- STEP 1: PURE SELECT STATE (No Card, No Container) -->
    <div id="uploadContainer" class="py-5 text-center fade-in">
        <div class="select-area-wrapper">
            <!-- THE MAIN ACTION BUTTON -->
            <div class="main-action-row">
                <button class="btn-ilove-main shadow-lg" onclick="document.getElementById('fileInput').click()">
                    Select images
                </button>
                
                <!-- Professional Cloud Icons (iLoveIMG Style) -->
                <div class="cloud-tray">
                    <div class="cloud-btn shadow-sm"><i class="fa-brands fa-google-drive"></i></div>
                    <div class="cloud-btn shadow-sm"><i class="fa-brands fa-dropbox"></i></div>
                </div>
            </div>
            
            <p class="drop-text">or drop images here</p>
            <input type="file" id="fileInput" hidden accept="image/*" multiple />
        </div>
    </div>

    <!-- STEP 2: WORKSPACE (Compact & Professional) -->
    <div id="processingArea" style="display:none;" class="fade-in">
        <div class="app-workspace-shell">
            <!-- Left: Asset Gallery (Gray) -->
            <div class="asset-gallery custom-scrollbar">
                <div id="imageGrid" class="asset-grid">
                    <!-- Cards will be injected here (198x244px) -->
                </div>
                <!-- Floating Add More Button -->
                <button class="btn-add-more shadow" onclick="document.getElementById('fileInput').click()">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <!-- Right: Settings Sidebar (White) -->
            <aside class="settings-sidebar">
                <div class="sidebar-inner">
                    <h5 class="fw-bold mb-3">Compress images</h5>
                    <div class="info-tag mb-4">
                        All images will be compressed with the best quality and size ratio.
                    </div>
                    
                    <button id="btnAction" class="btn-sidebar-execute">
                        Compress IMAGES <i class="fa-solid fa-arrow-right ms-2"></i>
                    </button>
                </div>
            </aside>
        </div>
    </div>

    <!-- STEP 3: RESULT -->
    <div id="resultArea" style="display:none;" class="text-center py-5 fade-in">
        <h2 class="fw-bold mb-4">Your IMAGES have been compressed!</h2>
        <a id="downloadBtn" class="btn-ilove-main d-inline-block text-decoration-none shadow-lg mb-4">
            Download compressed IMAGES
        </a>
        <div id="statsSummary" class="text-muted small fw-bold"></div>
    </div>
</div>

<style>
    /* --- THE SELECT BUTTON DESIGN --- */
    .select-area-wrapper {
        display: inline-block;
        position: relative;
    }

    .main-action-row {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .btn-ilove-main {
        background-color: #4b8df8; /* The classic iLoveIMG Blue */
        color: white;
        border: none;
        padding: 24px 80px;
        font-size: 2.2rem;
        font-weight: 700;
        border-radius: 12px;
        transition: background 0.2s, transform 0.2s;
        cursor: pointer;
    }

    .btn-ilove-main:hover {
        background-color: #3b7dec;
        transform: scale(1.02);
    }

    .cloud-tray {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .cloud-btn {
        width: 40px;
        height: 40px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #4b8df8;
        font-size: 1.2rem;
        cursor: pointer;
    }

    .drop-text {
        margin-top: 25px;
        color: #47474f;
        font-weight: 500;
        font-size: 1.1rem;
    }

    /* --- WORKSPACE APP DESIGN --- */
    .app-workspace-shell {
        display: flex;
        background: #fff;
        border-radius: 12px;
        border: 1px solid #e0e0e6;
        height: 600px;
        overflow: hidden;
        margin-top: 20px;
    }

    .asset-gallery {
        flex-grow: 1;
        background-color: #f3f3f7; /* Gray stage */
        padding: 20px;
        position: relative;
        overflow-y: auto;
    }

    .settings-sidebar {
        width: 340px;
        background: white;
        border-left: 1px solid #e0e0e6;
    }

    .sidebar-inner {
        padding: 25px;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .info-tag {
        background: #e8f1ff;
        color: #1a4da1;
        padding: 15px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .btn-sidebar-execute {
        width: calc(100% + 50px);
        margin-left: -25px;
        margin-bottom: -25px;
        margin-top: auto;
        background: #4b8df8;
        color: white;
        border: none;
        padding: 25px;
        font-size: 1.6rem;
        font-weight: 800;
        cursor: pointer;
    }

    /* --- YOUR 198x244 CARD LOGIC --- */
    .asset-grid {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
    }

    /* Using :global to ensure the JS-injected cards get these styles */
    #imageGrid :global(.image-preview-card) {
        margin: 6px;
        width: 198px;
        height: 244px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #fdfdfd;
        border-radius: 8px;
        box-shadow: 0 0 8px 0 rgba(0, 0, 0, .08);
        border: 1px solid transparent;
        transition: 0.2s;
    }

    #imageGrid :global(.image-preview-card img) {
        max-width: 160px;
        max-height: 160px;
        object-fit: contain;
    }

    #imageGrid :global(.image-preview-card .file-name) {
        font-size: 11px;
        font-weight: 700;
        color: #777;
        margin-top: 15px;
        width: 80%;
        text-align: center;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .btn-add-more {
        position: absolute; bottom: 25px; right: 25px; width: 60px; height: 60px;
        background: #4b8df8; color: white; border: none; border-radius: 50%;
        font-size: 1.5rem; display: flex; align-items: center; justify-content: center;
        cursor: pointer;
    }

    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d1d6; border-radius: 10px; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>

<script is:inline>
    const fileInput = document.getElementById('fileInput');
    const uploadContainer = document.getElementById('uploadContainer');
    const processingArea = document.getElementById('processingArea');
    const imageGrid = document.getElementById('imageGrid');
    const btnAction = document.getElementById('btnAction');
    const resultArea = document.getElementById('resultArea');

    let queue = [];

    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        uploadContainer.style.display = 'none';
        processingArea.style.display = 'flex';

        files.forEach(file => {
            queue.push(file);
            const card = document.createElement('div');
            card.className = 'image-preview-card';
            card.innerHTML = `
                <img src="${URL.createObjectURL(file)}">
                <span class="file-name">${file.name}</span>
            `;
            imageGrid.appendChild(card);
        });
    });

    btnAction.addEventListener('click', async () => {
        btnAction.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
        btnAction.disabled = true;

        let totalOld = 0; let totalNew = 0;
        const zip = new JSZip();

        for (const file of queue) {
            totalOld += file.size;
            try {
                const blob = await imageCompression(file, { maxSizeMB: 1, initialQuality: 0.7 });
                totalNew += blob.size;
                zip.file(`compressed-${file.name}`, blob);
            } catch (err) { totalNew += file.size; }
        }

        const zipBlob = await zip.generateAsync({ type: "blob" });
        const url = URL.createObjectURL(zipBlob);
        
        document.getElementById('statsSummary').innerText = `Total Saved: ${Math.round(((totalOld - totalNew)/totalOld)*100)}%`;
        document.getElementById('downloadBtn').href = url;
        document.getElementById('downloadBtn').download = "zyntool-images.zip";

        processingArea.style.display = 'none';
        resultArea.style.display = 'block';
    });
</script>
