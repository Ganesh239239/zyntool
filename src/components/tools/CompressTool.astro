---
const { entry, relatedTools } = Astro.props;
---

<div id="compress-tool-pro">
    <!-- 1. UPLOAD STATE (Clean & Minimal) -->
    <div id="uploadContainer" class="uploader-wrapper mx-auto">
        <div class="uploader-card-simple shadow-sm" onclick="document.getElementById('fileInput').click()">
            <div class="uploader-content">
                <div class="icon-box mb-4" style={`background: ${entry.data.color}`}>
                    <i class={`fa-solid ${entry.data.icon} text-white`}></i>
                </div>
                <h2 class="fw-bold text-dark mb-2">Select Images</h2>
                <p class="text-muted small">JPG, PNG, or WebP â€¢ No limits</p>
                <button class="btn btn-primary rounded-pill px-5 fw-bold mt-2">Browse Files</button>
                <input type="file" id="fileInput" hidden accept="image/*" multiple />
            </div>
        </div>
    </div>

    <!-- 2. BATCH WORKSPACE (App Layout) -->
    <div id="processingArea" style="display:none;" class="fade-in">
        <div class="row g-4 text-start">
            <!-- Left: Minimalist Queue -->
            <div class="col-lg-8">
                <div class="workspace-card card border-0 shadow-sm rounded-4 bg-white overflow-hidden">
                    <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-light">
                        <span class="fw-bold small text-muted uppercase">Image Queue</span>
                        <span id="queueCount" class="badge bg-dark rounded-pill">0 Files</span>
                    </div>
                    <div id="imageGrid" class="queue-list p-4 custom-scrollbar">
                        <!-- Cards injected here -->
                    </div>
                </div>
            </div>

            <!-- Right: Settings sidebar -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm rounded-4 p-4 sticky-top" style="top: 100px;">
                    <h5 class="fw-bold mb-4">Optimization Settings</h5>
                    
                    <div class="mb-4">
                        <label class="small fw-bold text-muted d-flex justify-content-between mb-2">
                            Compression Level <span id="qVal" class="text-primary fw-bold">Aggressive</span>
                        </label>
                        <select id="compMode" class="form-select border-0 bg-light rounded-3 fw-bold">
                            <option value="0.4">Aggressive (Smallest Size)</option>
                            <option value="0.7" selected>Recommended (Best Quality)</option>
                            <option value="0.9">Low (Original Quality)</option>
                        </select>
                    </div>

                    <button id="btnAction" class="btn btn-primary w-100 rounded-pill py-3 fw-bold shadow-lg mb-4">
                        Compress Images <i class="fa-solid fa-bolt ms-2"></i>
                    </button>

                    <div class="related-tools-mini border-top pt-4">
                        <p class="extra-small fw-bold text-muted mb-3 uppercase">Other Tools</p>
                        <div class="row g-2">
                            {relatedTools.slice(0,4).map(t => (
                                <div class="col-6">
                                    <a href={`/${t.slug || t.id}`} class="mini-tool-link">
                                        <i class={`fa-solid ${t.data.icon}`} style={`color: ${t.data.color}`}></i>
                                        <span>{t.data.title.split(' ')[0]}</span>
                                    </a>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. SUCCESS STATE (High-Performance Result) -->
    <div id="resultArea" style="display:none;" class="text-center py-5 fade-in mx-auto" style="max-width: 700px;">
        <div class="result-card card bg-white shadow-xl p-5 rounded-5 border-0">
            <div class="success-icon mb-4"><i class="fa-solid fa-circle-check"></i></div>
            <h2 class="fw-black mb-1 h1">Your Images are now <span id="pctSaved" class="text-success">0%</span> lighter!</h2>
            <p class="text-muted mb-5" id="sizeSummary">0 KB reduced to 0 KB</p>
            
            <div class="d-flex gap-3 flex-wrap justify-content-center">
                <a id="downloadBtn" class="btn btn-primary btn-lg px-5 py-3 rounded-pill fw-bold shadow-xl d-flex align-items-center">
                    <i class="fa-solid fa-cloud-arrow-down me-2"></i> Download All
                </a>
                <button class="btn btn-outline-dark px-5 py-3 rounded-pill border-2 fw-bold" onclick="location.reload()">
                    <i class="fa-solid fa-rotate-left me-2"></i> Compress More
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* --- ELITE MINIMALIST SYSTEM --- */
    .fw-black { font-weight: 900; }
    .shadow-xl { box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
    .extra-small { font-size: 0.65rem; }

    /* Uploader */
    .uploader-wrapper { max-width: 700px; }
    .uploader-card-simple { background: #fff; border-radius: 32px; padding: 15px; border: 1px solid #f1f5f9; cursor: pointer; transition: 0.3s; }
    .uploader-card-simple:hover { border-color: var(--primary-blue); transform: translateY(-4px); }
    .uploader-content { border: 2px dashed #e2e8f0; border-radius: 24px; padding: 60px 20px; }
    
    .icon-box { width: 70px; height: 70px; border-radius: 50%; margin: 0 auto; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; box-shadow: 0 8px 20px rgba(0,0,0,0.05); }

    /* Workspace */
    .queue-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; max-height: 500px; overflow-y: auto; }
    .file-card { background: #fff; border: 1px solid #f1f5f9; border-radius: 16px; padding: 10px; text-align: center; transition: 0.2s; }
    .file-card:hover { border-color: var(--primary-blue); }
    .file-card img { width: 100%; height: 90px; object-fit: contain; border-radius: 8px; margin-bottom: 8px; }
    .file-card .name { font-size: 0.7rem; font-weight: 700; color: #64748b; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* Related tools */
    .mini-tool-link { display: flex; align-items: center; gap: 8px; padding: 10px; border: 1px solid #f1f5f9; border-radius: 12px; text-decoration: none; color: #1e293b; font-size: 0.75rem; font-weight: 700; transition: 0.2s; }
    .mini-tool-link:hover { background: #f8fafc; border-color: var(--primary-blue); }

    /* Success */
    .success-icon { width: 80px; height: 80px; background: #ecfdf5; color: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-size: 2.5rem; }

    .custom-scrollbar::-webkit-scrollbar { width: 5px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
</style>

<script is:inline>
    const fileInput = document.getElementById('fileInput');
    const uploadContainer = document.getElementById('uploadContainer');
    const processingArea = document.getElementById('processingArea');
    const btnAction = document.getElementById('btnAction');
    const resultArea = document.getElementById('resultArea');
    const imageGrid = document.getElementById('imageGrid');

    let queue = [];

    function formatBytes(bytes) {
        if (bytes === 0) return '0 KB';
        return parseFloat((bytes / 1024).toFixed(2)) + ' KB';
    }

    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (!files.length) return;

        uploadContainer.style.display = 'none';
        processingArea.style.display = 'block';
        document.getElementById('queueCount').innerText = `${files.length} Files`;

        files.forEach(file => {
            queue.push(file);
            const card = document.createElement('div');
            card.className = 'file-card shadow-sm';
            card.innerHTML = `<img src="${URL.createObjectURL(file)}"><span class="name">${file.name}</span>`;
            imageGrid.appendChild(card);
        });
    });

    btnAction.addEventListener('click', async () => {
        btnAction.disabled = true;
        btnAction.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Optimizing...';

        let totalOld = 0;
        let totalNew = 0;
        const zip = new JSZip();
        const mode = parseFloat(document.getElementById('compMode').value);

        for (let file of queue) {
            totalOld += file.size;
            try {
                // THE AGGRESSIVE ENGINE FIX: Lower quality and target size
                const options = {
                    maxSizeMB: 0.1, // Target 100KB (Aggressive)
                    initialQuality: mode,
                    useWebWorker: true,
                    maxIteration: 20 // Force more passes for smaller size
                };
                
                const blob = await imageCompression(file, options);
                totalNew += blob.size;
                zip.file(`optimized-${file.name}`, blob);
            } catch (err) {
                totalNew += file.size;
            }
        }

        // Calculation
        const savings = Math.max(0, Math.round(((totalOld - totalNew) / totalOld) * 100));
        document.getElementById('pctSaved').innerText = `${savings}%`;
        document.getElementById('sizeSummary').innerText = `${formatBytes(totalOld)} reduced to ${formatBytes(totalNew)}`;

        const zipBlob = await zip.generateAsync({ type: "blob" });
        const url = URL.createObjectURL(zipBlob);
        document.getElementById('downloadBtn').href = url;
        document.getElementById('downloadBtn').download = "zyntool-compressed.zip";

        processingArea.style.display = 'none';
        resultArea.style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
</script>
