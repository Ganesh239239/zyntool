---
const { entry, relatedTools } = Astro.props;
---

<div id="compress-tool">
    <!-- STEP 1: UPLOAD BOX (Kept exactly as it was) -->
    <div id="uploadContainer" class="uploader-card shadow-lg mb-5 bg-white mx-auto" style="max-width: 800px;">
        <div class="uploader-border-wrapper p-3"> 
            <div class="uploader-zone text-center" onclick="document.getElementById('fileInput').click()" style="cursor:pointer">
                <div class="icon-circle mb-3 mx-auto" style={`background: ${entry.data.color}15; color: ${entry.data.color}; width:80px; height:80px; border-radius:50%; display:flex; align-items:center; justify-content:center;`}>
                    <i class={`fa-solid ${entry.data.icon} fa-3x`}></i>
                </div>
                <h2 class="fw-bold text-dark">Select Images</h2>
                <p class="text-muted small">Upload multiple images to compress in bulk</p>
                <input type="file" id="fileInput" hidden accept="image/jpeg,image/png,image/webp" multiple />
            </div>
        </div>
    </div>

    <!-- STEP 2: PROFESSIONAL LIST WORKSPACE (No Preview Image) -->
    <div id="processingArea" style="display:none;" class="fade-in">
        <div class="row g-4 text-start">
            
            <!-- LEFT COLUMN: BATCH QUEUE LIST -->
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm rounded-4 bg-white overflow-hidden">
                    <div class="card-header bg-light border-bottom p-3 d-flex justify-content-between align-items-center">
                        <h6 class="fw-bold m-0"><i class="fa-solid fa-list-ul me-2"></i> Processing Queue</h6>
                        <span id="queueCount" class="badge bg-dark rounded-pill">0 Files</span>
                    </div>
                    <div id="fileListContainer" class="p-0" style="max-height: 500px; overflow-y: auto;">
                        <!-- List items injected by JS -->
                        <div class="text-center py-5 text-muted" id="emptyList">
                            <div class="spinner-border spinner-border-sm mb-2"></div>
                            <p class="small mb-0">Initializing engine...</p>
                        </div>
                    </div>
                </div>
                <p class="text-muted extra-small mt-3">
                    <i class="fa-solid fa-shield-halved me-1"></i> 100% Private: All compression happens inside your browser. Files are never uploaded.
                </p>
            </div>

            <!-- RIGHT COLUMN: GLOBAL SETTINGS -->
            <div class="col-lg-4">
                <div class="sidebar-sticky">
                    <div class="card border-0 shadow-sm rounded-4 p-4 mb-4 bg-white">
                        <h5 class="fw-bold mb-4 d-flex align-items-center">
                            <i class="fa-solid fa-sliders me-2 text-primary"></i> Settings
                        </h5>
                        
                        <div class="mb-4">
                            <label class="small fw-bold text-muted d-flex justify-content-between mb-2">
                                Global Quality <span id="qVal" class="badge bg-primary">70%</span>
                            </label>
                            <input type="range" id="qIn" class="form-range" min="10" max="100" step="1" value="70">
                            <div class="d-flex justify-content-between extra-small text-muted mt-2">
                                <span>Smallest Size</span>
                                <span>Best Quality</span>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button id="btnAction" class="btn btn-lg text-white rounded-pill py-3 fw-bold shadow-sm border-0" style={`background: ${entry.data.color}`}>
                                <i class="fa-solid fa-bolt me-2"></i> Compress All
                            </button>
                        </div>
                    </div>

                    <!-- RELATED TOOLS -->
                    <div class="card border-0 shadow-sm rounded-4 p-4 bg-white d-none d-lg-block">
                        <p class="extra-small fw-bold text-muted uppercase mb-3">Check these out</p>
                        <div class="row g-2">
                            {relatedTools.map(t => (
                                <div class="col-6">
                                    <a href={`/${t.slug || t.id}`} class="related-link">
                                        <i class={`fa-solid ${t.data.icon}`} style={`color: ${t.data.color}`}></i>
                                        <span class="text-truncate">{t.data.title.split(' ')[0]}</span>
                                    </a>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- STEP 3: SUCCESS RESULT (iLoveIMG Style Stats) -->
    <div id="resultArea" style="display:none;" class="text-center py-5 fade-in mx-auto" style="max-width: 650px;">
        <div class="result-card card bg-white shadow-lg p-5 rounded-5 border-0">
            <div class="success-badge mb-4"><i class="fa-solid fa-circle-check"></i></div>
            <h2 class="fw-black mb-1">Compression Done!</h2>
            <p class="text-muted mb-4">Your images are now optimized and ready for use.</p>
            
            <div class="row g-3 my-4 justify-content-center">
                <div class="col-6 col-sm-4">
                    <div class="p-2 border rounded-4 bg-light">
                        <div class="extra-small text-muted mb-1">Old Total</div>
                        <div id="totalOldSize" class="fw-bold">0 KB</div>
                    </div>
                </div>
                <div class="col-6 col-sm-4">
                    <div class="p-2 border rounded-4 bg-light">
                        <div class="extra-small text-muted mb-1">New Total</div>
                        <div id="totalNewSize" class="fw-bold text-success">0 KB</div>
                    </div>
                </div>
                <div class="col-12 col-sm-4">
                    <div class="p-2 border rounded-4 bg-primary text-white shadow-sm">
                        <div class="extra-small opacity-75 mb-1">Total Lighter</div>
                        <div id="totalPercent" class="fw-bold fs-5">0%</div>
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2 flex-wrap justify-content-center pt-2">
                <a id="downloadAllBtn" class="btn btn-dark px-5 py-3 rounded-pill fw-bold shadow-sm">
                    <i class="fa-solid fa-file-zipper me-2"></i> Download as ZIP
                </a>
                <button class="btn btn-outline-secondary px-4 rounded-pill border-2 fw-bold" onclick="location.reload()">
                    Start Over
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .fw-black { font-weight: 900; }
    .extra-small { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }

    /* Queue List Styling */
    .file-item {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid #f1f5f9;
        transition: background 0.2s;
    }
    .file-item:hover { background: #f8fafc; }
    .file-thumb { width: 45px; height: 45px; border-radius: 8px; object-fit: cover; margin-right: 15px; border: 1px solid #eee; }
    .file-info { flex-grow: 1; min-width: 0; }
    .file-name { font-weight: 700; color: #1e293b; font-size: 0.9rem; margin-bottom: 2px; }
    .file-stats { font-size: 0.75rem; color: #64748b; }
    .file-status { margin-left: 15px; }

    .sidebar-sticky { position: sticky; top: 100px; }
    .related-link {
        display: flex; align-items: center; gap: 8px; padding: 10px; border: 1px solid #edf2f7;
        border-radius: 12px; text-decoration: none; color: #4a5568; font-size: 0.8rem; font-weight: 600;
    }
    .related-link:hover { border-color: #4B90FF; background: #f8fafc; }
    .success-badge { width: 70px; height: 70px; background: #ecfdf5; color: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-size: 2rem; }
</style>

<script is:inline>
    const fileInput = document.getElementById('fileInput');
    const uploadContainer = document.getElementById('uploadContainer');
    const processingArea = document.getElementById('processingArea');
    const fileListContainer = document.getElementById('fileListContainer');
    const btnAction = document.getElementById('btnAction');
    const resultArea = document.getElementById('resultArea');
    const qIn = document.getElementById('qIn');
    const qVal = document.getElementById('qVal');

    let queue = [];

    function formatBytes(bytes) {
        if (bytes === 0) return '0 KB';
        const k = 1024;
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + ['B', 'KB', 'MB'][i];
    }

    qIn.oninput = (e) => qVal.innerText = e.target.value + '%';

    fileInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        uploadContainer.style.display = 'none';
        processingArea.style.display = 'block';
        fileListContainer.innerHTML = '';
        document.getElementById('queueCount').innerText = `${files.length} Files`;

        files.forEach((file, i) => {
            const item = { file, originalSize: file.size, compressedBlob: null };
            queue.push(item);

            // Create List Item UI
            const itemDiv = document.createElement('div');
            itemDiv.className = 'file-item';
            itemDiv.id = `item-${i}`;
            itemDiv.innerHTML = `
                <img src="${URL.createObjectURL(file)}" class="file-thumb">
                <div class="file-info">
                    <div class="file-name text-truncate">${file.name}</div>
                    <div class="file-stats">Original: ${formatBytes(file.size)} â€¢ <span class="text-success" id="newSize-${i}">Waiting...</span></div>
                </div>
                <div class="file-status" id="status-${i}">
                    <i class="fa-solid fa-clock text-muted"></i>
                </div>
            `;
            fileListContainer.appendChild(itemDiv);
        });
    });

    btnAction.addEventListener('click', async () => {
        btnAction.disabled = true;
        btnAction.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Compressing...';

        let totalOld = 0;
        let totalNew = 0;
        const zip = new JSZip();

        for (let i = 0; i < queue.length; i++) {
            const item = queue[i];
            const statusIcon = document.getElementById(`status-${i}`);
            statusIcon.innerHTML = '<div class="spinner-border spinner-border-sm text-primary"></div>';

            try {
                const options = {
                    maxSizeMB: 1,
                    initialQuality: parseInt(qIn.value) / 100,
                    useWebWorker: true
                };
                
                const blob = await imageCompression(item.file, options);
                item.compressedBlob = blob;
                
                totalOld += item.originalSize;
                totalNew += blob.size;

                document.getElementById(`newSize-${i}`).innerText = `New: ${formatBytes(blob.size)}`;
                statusIcon.innerHTML = '<i class="fa-solid fa-circle-check text-success"></i>';
                
                zip.file(`optimized-${item.file.name}`, blob);
            } catch (e) {
                statusIcon.innerHTML = '<i class="fa-solid fa-circle-xmark text-danger"></i>';
            }
        }

        // Show Final Result
        setTimeout(async () => {
            document.getElementById('totalOldSize').innerText = formatBytes(totalOld);
            document.getElementById('totalNewSize').innerText = formatBytes(totalNew);
            const saved = Math.max(0, Math.round(((totalOld - totalNew) / totalOld) * 100));
            document.getElementById('totalPercent').innerText = `${saved}%`;

            const zipContent = await zip.generateAsync({ type: "blob" });
            const dlBtn = document.getElementById('downloadAllBtn');
            dlBtn.href = URL.createObjectURL(zipContent);
            dlBtn.download = "zyntool-bulk-optimized.zip";

            processingArea.style.display = 'none';
            resultArea.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 500);
    });
</script>
