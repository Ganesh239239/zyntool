---
const { entry, relatedTools } = Astro.props;
---

<div id="tool-root" class="iloveimg-layout">
    <!-- 1. SELECT STATE (Initial View) -->
    <div id="view-select" class="view-stage active">
        <div class="text-center py-5">
            <h1 class="display-4 fw-bold text-dark mb-2">Compress IMAGE</h1>
            <p class="fs-5 text-muted mb-5">Compress JPG, PNG, SVG, or GIF with the best quality and compression.<br/>Reduce the filesize of your images at once.</p>
            
            <div class="upload-box-wrapper mx-auto">
                <button class="btn-select-main shadow-lg" onclick="document.getElementById('fileInput').click()">
                    Select images
                </button>
                <div class="cloud-options mt-2 d-flex justify-content-center gap-2">
                    <div class="cloud-icon"><i class="fa-brands fa-google-drive"></i></div>
                    <div class="cloud-icon"><i class="fa-brands fa-dropbox"></i></div>
                </div>
                <p class="mt-4 text-muted small">or drop images here</p>
                <input type="file" id="fileInput" hidden accept="image/*" multiple />
            </div>
        </div>
    </div>

    <!-- 2. WORKSPACE STATE (After Upload) -->
    <div id="view-workspace" class="view-stage flex-container" style="display:none;">
        <!-- Left: Image Gallery -->
        <div class="gallery-side p-4">
            <div id="imageGrid" class="image-grid">
                <!-- Thumbnails injected here -->
            </div>
            <!-- Floating Add Button -->
            <button class="btn-add-more shadow" onclick="document.getElementById('fileInput').click()">
                <i class="fa-solid fa-plus"></i>
                <span class="tooltip-text">Add more images</span>
            </button>
        </div>

        <!-- Right: Control Sidebar -->
        <aside class="control-sidebar shadow-sm">
            <div class="p-4">
                <h3 class="fw-bold mb-4">Compress images</h3>
                <div class="alert alert-info border-0 rounded-3 small">
                    All images will be compressed with the best quality and filesize ratio.
                </div>
            </div>
            
            <button id="btnProcess" class="btn-process-main">
                Compress IMAGES <i class="fa-solid fa-circle-arrow-right ms-2"></i>
            </button>
        </aside>
    </div>

    <!-- 3. SUCCESS STATE (After Processing) -->
    <div id="view-success" class="view-stage text-center py-5" style="display:none;">
        <h1 class="fw-bold mb-4">Your IMAGES have been compressed!</h1>
        
        <div class="download-container mx-auto mb-5">
            <a id="downloadBtn" class="btn-download-main shadow-lg">
                <i class="fa-solid fa-download me-2"></i> Download compressed IMAGES
            </a>
            <div class="social-cloud-icons mt-3 d-flex justify-content-center gap-2">
                 <div class="icon-circle-sm"><i class="fa-brands fa-google-drive"></i></div>
                 <div class="icon-circle-sm"><i class="fa-brands fa-dropbox"></i></div>
                 <div class="icon-circle-sm"><i class="fa-solid fa-link"></i></div>
                 <div class="icon-circle-sm"><i class="fa-solid fa-trash-can"></i></div>
            </div>
        </div>

        <!-- Progress Ring & Stats -->
        <div class="d-flex align-items-center justify-content-center gap-4 mb-5">
            <div class="progress-ring-container">
                <svg width="100" height="100">
                    <circle class="ring-bg" cx="50" cy="50" r="45"></circle>
                    <circle id="progressRing" class="ring-fill" cx="50" cy="50" r="45"></circle>
                </svg>
                <div id="pctSavedLabel" class="ring-text">0%</div>
                <div class="ring-subtext">SAVED</div>
            </div>
            <div class="text-start">
                <p class="mb-1 text-muted">Your Images are now <span id="pctSavedText">0%</span> smaller!</p>
                <h5 class="fw-bold" id="sizeComparison">0 KB → 0 KB</h5>
            </div>
        </div>

        <!-- Continue To... Section -->
        <div class="continue-section mx-auto p-4 bg-white rounded-4 shadow-sm border" style="max-width: 800px;">
            <p class="fw-bold text-start mb-3">Continue to...</p>
            <div class="row g-3">
                {relatedTools.slice(0, 5).map(t => (
                    <div class="col-md-4">
                        <a href={`/${t.slug || t.id}`} class="tool-card-link">
                            <div class="d-flex align-items-center p-3 border rounded-3 h-100">
                                <div class="tool-icon-sm me-3" style={`color: ${t.data.color}`}>
                                    <i class={`fa-solid ${t.data.icon}`}></i>
                                </div>
                                <span class="fw-bold small">{t.data.title}</span>
                                <i class="fa-solid fa-chevron-right ms-auto opacity-25"></i>
                            </div>
                        </a>
                    </div>
                ))}
            </div>
        </div>
    </div>
</div>

<style>
    /* --- iLoveIMG STYLE SYSTEM --- */
    .iloveimg-layout { min-height: 70vh; }
    
    /* Buttons */
    .btn-select-main {
        background: #4b8df8; color: #fff; border: none; padding: 25px 80px;
        font-size: 2rem; font-weight: 700; border-radius: 12px; transition: 0.2s;
    }
    .btn-select-main:hover { transform: scale(1.02); background: #3b7dec; }

    .btn-process-main {
        position: absolute; bottom: 0; left: 0; width: 100%;
        background: #4b8df8; color: #fff; border: none; padding: 25px;
        font-size: 1.8rem; font-weight: 700; transition: 0.2s;
    }
    
    .btn-download-main {
        display: inline-block; background: #4b8df8; color: #fff; border: none;
        padding: 20px 50px; font-size: 1.5rem; font-weight: 700; border-radius: 12px;
        text-decoration: none; cursor: pointer;
    }

    /* Workspace Layout */
    .flex-container { display: flex; min-height: 80vh; background: #f2f3f5; margin: 0 -15px; }
    .gallery-side { flex-grow: 1; position: relative; }
    .control-sidebar { width: 360px; background: #fff; position: relative; border-left: 1px solid #ddd; }

    .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
    .img-card { background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
    .img-card img { width: 100%; height: 120px; object-fit: contain; margin-bottom: 10px; }
    .img-card span { font-size: 0.75rem; color: #666; display: block; overflow: hidden; text-overflow: ellipsis; }

    .btn-add-more {
        position: absolute; top: 20px; right: 20px; width: 50px; height: 50px;
        background: #4b8df8; color: #fff; border: none; border-radius: 50%;
        font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
    }

    /* Progress Ring */
    .ring-bg { fill: none; stroke: #eee; stroke-width: 8; }
    .ring-fill { fill: none; stroke: #4b8df8; stroke-width: 8; stroke-linecap: round; stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 1s ease-out; transform: rotate(-90deg); transform-origin: 50% 50%; }
    .progress-ring-container { position: relative; width: 100px; height: 100px; }
    .ring-text { position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%); font-weight: 900; font-size: 1.2rem; }
    .ring-subtext { position: absolute; bottom: 25%; left: 50%; transform: translateX(-50%); font-size: 0.6rem; font-weight: 700; color: #666; }

    /* Success Components */
    .tool-card-link { text-decoration: none; color: inherit; }
    .tool-card-link:hover .border { border-color: #4b8df8 !important; }
    .icon-circle-sm { width: 40px; height: 40px; border: 1px solid #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #4b8df8; cursor: pointer; }
    .icon-circle-sm:hover { background: #f8f9fa; }

    /* Misc */
    .cloud-icon { font-size: 1.5rem; color: #4b8df8; cursor: pointer; }
    .fs-xs { font-size: 0.7rem; }
</style>

<script is:inline>
    const fileInput = document.getElementById('fileInput');
    const viewSelect = document.getElementById('view-select');
    const viewWorkspace = document.getElementById('view-workspace');
    const viewSuccess = document.getElementById('view-success');
    const imageGrid = document.getElementById('imageGrid');
    const btnProcess = document.getElementById('btnProcess');
    
    let filesQueue = [];

    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        viewSelect.style.display = 'none';
        viewWorkspace.style.display = 'flex';

        files.forEach(file => {
            filesQueue.push(file);
            const card = document.createElement('div');
            card.className = 'img-card';
            card.innerHTML = `
                <img src="${URL.createObjectURL(file)}">
                <span title="${file.name}">${file.name}</span>
            `;
            imageGrid.appendChild(card);
        });
    });

    btnProcess.addEventListener('click', async () => {
        btnProcess.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
        btnProcess.disabled = true;

        let totalOriginal = 0;
        let totalCompressed = 0;
        const zip = new JSZip();

        for (const file of filesQueue) {
            totalOriginal += file.size;
            try {
                const blob = await imageCompression(file, { maxSizeMB: 1, initialQuality: 0.7 });
                totalCompressed += blob.size;
                zip.file(`compressed-${file.name}`, blob);
            } catch (err) {
                totalCompressed += file.size;
            }
        }

        // Final UI Updates
        const pct = Math.round(((totalOriginal - totalCompressed) / totalOriginal) * 100);
        document.getElementById('pctSavedLabel').innerText = pct + '%';
        document.getElementById('pctSavedText').innerText = pct + '%';
        document.getElementById('sizeComparison').innerText = `${(totalOriginal/1024).toFixed(1)} KB → ${(totalCompressed/1024).toFixed(1)} KB`;
        
        // Animate Ring
        const offset = 283 - (283 * pct) / 100;
        document.getElementById('progressRing').style.strokeDashoffset = offset;

        // Prepare ZIP download
        const zipBlob = await zip.generateAsync({ type: 'blob' });
        const url = URL.createObjectURL(zipBlob);
        const dlBtn = document.getElementById('downloadBtn');
        dlBtn.href = url;
        dlBtn.download = "zyntool-images.zip";

        viewWorkspace.style.display = 'none';
        viewSuccess.style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
</script>
