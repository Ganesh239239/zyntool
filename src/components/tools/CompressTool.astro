---
const { entry } = Astro.props;
---

<div id="compress-engine">
    <!-- VIEW 1: SELECT BUTTON (Like iLoveIMG home) -->
    <div id="uploadContainer" class="py-5">
        <div class="text-center">
            <button class="btn-select-main shadow-lg" onclick="document.getElementById('fileInput').click()">
                Select images
            </button>
            <p class="mt-3 text-muted">or drop images here</p>
            <input type="file" id="fileInput" hidden accept="image/*" multiple />
        </div>
    </div>

    <!-- VIEW 2: COMPACT WORKSPACE (Like iLoveIMG Workspace) -->
    <div id="processingArea" style="display:none;" class="fade-in">
        <div class="row g-0 bg-white shadow-sm rounded-4 overflow-hidden border">
            
            <!-- LEFT: Gallery (Compact Thumbnails) -->
            <div class="col-lg-8 bg-light p-4" style="min-height: 450px; background-color: #f8f9fa !important;">
                <div id="imageGrid" class="image-grid-compact">
                    <!-- Thumbnails go here -->
                </div>
                
                <!-- Floating Add Button -->
                <button class="btn-add-more shadow" onclick="document.getElementById('fileInput').click()">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <!-- RIGHT: Sidebar (Sticky & Clean) -->
            <div class="col-lg-4 border-start p-4 bg-white d-flex flex-column">
                <h4 class="fw-bold mb-3">Compress images</h4>
                <div class="alert alert-primary border-0 small mb-4 py-2">
                    All images will be compressed with the best quality and size ratio.
                </div>

                <div class="mt-auto">
                    <button id="btnAction" class="btn btn-primary w-100 fw-bold py-3 rounded-3 fs-4 shadow-sm">
                        Compress IMAGES <i class="fa-solid fa-circle-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW 3: SUCCESS RESULT -->
    <div id="resultArea" style="display:none;" class="text-center py-5 fade-in">
        <h1 class="fw-bold text-dark mb-4">Your IMAGES have been compressed!</h1>
        <a id="downloadBtn" class="btn btn-primary px-5 py-3 rounded-3 fw-bold shadow-lg h3">
            Download compressed IMAGES
        </a>
        <div id="savingsInfo" class="mt-3 text-muted fw-bold"></div>
        <button class="btn btn-link text-decoration-none mt-4" onclick="location.reload()">Compress more images</button>
    </div>
</div>

<style>
    /* THE BIG SELECT BUTTON */
    .btn-select-main {
        background-color: #4b8df8;
        color: white;
        border: none;
        padding: 25px 80px;
        font-size: 2.2rem;
        font-weight: 700;
        border-radius: 12px;
        transition: 0.2s;
    }
    .btn-select-main:hover { background-color: #3b7dec; transform: scale(1.02); }

    /* COMPACT GALLERY GRID */
    .image-grid-compact {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 15px;
    }

    .thumb-card {
        background: white;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid #ddd;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        position: relative;
    }

    /* THE FIX: Image size is strictly controlled here */
    .thumb-card img {
        width: 100%;
        height: 100px;
        object-fit: contain; /* Keeps image shape without stretching */
        margin-bottom: 8px;
    }

    .thumb-card span {
        font-size: 0.65rem;
        color: #666;
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .btn-add-more {
        position: absolute; bottom: 20px; right: 20px; width: 50px; height: 50px;
        background: #4b8df8; color: white; border: none; border-radius: 50%;
        font-size: 1.5rem; cursor: pointer;
    }

    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>

<script is:inline>
    const fileInput = document.getElementById('fileInput');
    const uploadContainer = document.getElementById('uploadContainer');
    const processingArea = document.getElementById('processingArea');
    const imageGrid = document.getElementById('imageGrid');
    const btnAction = document.getElementById('btnAction');
    const resultArea = document.getElementById('resultArea');

    let queue = [];

    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        uploadContainer.style.display = 'none';
        processingArea.style.display = 'block';
        document.getElementById('tool-header-text').style.display = 'none'; // Hide text to save space

        files.forEach(file => {
            queue.push(file);
            const div = document.createElement('div');
            div.className = 'thumb-card fade-in';
            div.innerHTML = `
                <img src="${URL.createObjectURL(file)}">
                <span title="${file.name}">${file.name}</span>
            `;
            imageGrid.appendChild(div);
        });
    });

    btnAction.addEventListener('click', async () => {
        btnAction.disabled = true;
        btnAction.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';

        let oldTotal = 0; let newTotal = 0;
        const zip = new JSZip();

        for (const file of queue) {
            oldTotal += file.size;
            try {
                const blob = await imageCompression(file, { maxSizeMB: 1, initialQuality: 0.7 });
                newTotal += blob.size;
                zip.file(`compressed-${file.name}`, blob);
            } catch (err) { newTotal += file.size; }
        }

        const zipBlob = await zip.generateAsync({ type: "blob" });
        const url = URL.createObjectURL(zipBlob);
        
        const savings = Math.round(((oldTotal - newTotal) / oldTotal) * 100);
        document.getElementById('savingsInfo').innerText = `Saved ${savings}% of file size!`;
        document.getElementById('downloadBtn').href = url;
        document.getElementById('downloadBtn').download = "zyntool-images.zip";

        processingArea.style.display = 'none';
        resultArea.style.display = 'block';
    });
</script>
