---
const { entry, relatedTools } = Astro.props;
---

<div id="tool-root" class="zyn-premium-suite">
    <!-- 1. INITIAL SELECT VIEW -->
    <div id="view-select" class="view-stage active">
        <div class="uploader-container mx-auto">
            <div class="uploader-glass shadow-2xl" onclick="document.getElementById('fileInput').click()">
                <div class="uploader-inner-dash">
                    <div class="icon-pulse mb-4" style={`background: ${entry.data.color}`}>
                        <i class={`fa-solid ${entry.data.icon} text-white`}></i>
                    </div>
                    <h2 class="fw-bold text-dark h3">Drop Images Here</h2>
                    <p class="text-muted small mb-4">Support for JPG, PNG, and WebP â€¢ Max 20 files</p>
                    <button class="btn btn-indigo rounded-pill px-5 py-3 fw-bold shadow-lg">
                        Select Images
                    </button>
                    <input type="file" id="fileInput" hidden accept="image/*" multiple />
                </div>
            </div>
            <!-- Cloud Integration Icons (Unique Layout) -->
            <div class="d-flex justify-content-center gap-4 mt-4 opacity-50">
                <i class="fa-brands fa-google-drive fa-lg cursor-pointer hover-indigo"></i>
                <i class="fa-brands fa-dropbox fa-lg cursor-pointer hover-indigo"></i>
            </div>
        </div>
    </div>

    <!-- 2. BATCH WORKSPACE -->
    <div id="view-workspace" class="view-stage workspace-layout" style="display:none;">
        <!-- Left: Image Gallery with Depth -->
        <div class="gallery-area p-4 scrollable custom-scrollbar">
            <div id="imageGrid" class="modern-grid">
                <!-- Cards injected here -->
            </div>
            <!-- Add More Button (Floating Unique Design) -->
            <button class="btn-floating-add shadow-lg" onclick="document.getElementById('fileInput').click()">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <!-- Right: Control Panel (Floating Look) -->
        <aside class="side-panel p-4">
            <div class="panel-card shadow-xl p-4 bg-white rounded-4">
                <h5 class="fw-bold mb-3 d-flex align-items-center">
                    <i class="fa-solid fa-sliders me-2 text-primary"></i> Optimization
                </h5>
                <p class="text-muted extra-small mb-4">We will use our aggressive engine to remove metadata and shrink pixels.</p>
                
                <div class="mb-4">
                    <label class="small fw-bold mb-2 d-flex justify-content-between">Quality <span>70%</span></label>
                    <input type="range" class="form-range custom-range" value="70">
                </div>

                <button id="btnProcess" class="btn btn-indigo w-100 rounded-pill py-3 fw-bold mt-2">
                    Optimize Batch <i class="fa-solid fa-bolt-lightning ms-2"></i>
                </button>
            </div>
        </aside>
    </div>

    <!-- 3. SUCCESS VIEW (Modern Scorecard) -->
    <div id="view-success" class="view-stage py-5" style="display:none;">
        <div class="container text-center">
            <div class="success-hero-card shadow-2xl bg-white rounded-5 p-5 mx-auto" style="max-width: 800px;">
                <div class="celebration-icon mb-4"><i class="fa-solid fa-circle-check"></i></div>
                <h1 class="fw-black h2 mb-2">Images Successfully Compressed!</h1>
                <p class="text-muted mb-5">Your files are lighter, faster, and ready for use.</p>

                <div class="stats-grid row g-3 mb-5">
                    <div class="col-md-4">
                        <div class="stat-card p-3 rounded-4 bg-light border-0">
                            <span class="d-block extra-small text-muted fw-bold">BEFORE</span>
                            <span id="statOld" class="h5 fw-bold">0 KB</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card p-3 rounded-4 bg-light border-0">
                            <span class="d-block extra-small text-muted fw-bold">AFTER</span>
                            <span id="statNew" class="h5 fw-bold text-indigo">0 KB</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card p-3 rounded-4 bg-indigo text-white shadow-lg">
                            <span class="d-block extra-small opacity-75 fw-bold">SAVED</span>
                            <span id="statSaved" class="h4 fw-black">0%</span>
                        </div>
                    </div>
                </div>

                <div class="d-flex flex-wrap gap-3 justify-content-center">
                    <a id="downloadBtn" class="btn btn-dark px-5 py-3 rounded-pill fw-bold shadow-xl">
                        <i class="fa-solid fa-cloud-arrow-down me-2"></i> Download ZIP
                    </a>
                    <button class="btn btn-outline-indigo px-5 py-3 rounded-pill border-2 fw-bold" onclick="location.reload()">
                        Compress Another Batch
                    </button>
                </div>

                <!-- Footer Tool Links -->
                <div class="mt-5 pt-5 border-top text-start">
                    <p class="extra-small fw-bold text-muted mb-3 tracking-widest uppercase">Next Steps</p>
                    <div class="row g-2">
                        {relatedTools.slice(0, 3).map(t => (
                            <div class="col-md-4">
                                <a href={`/${t.slug || t.id}`} class="tool-mini-card shadow-sm border rounded-3 p-2 d-flex align-items-center text-decoration-none text-dark">
                                    <i class={`fa-solid ${t.data.icon} me-2`} style={`color: ${t.data.color}`}></i>
                                    <span class="small fw-bold">{t.data.title.split(' ')[0]}</span>
                                </a>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* --- ZYNTOOL UNIQUE SYSTEM --- */
    .zyn-premium-suite { min-height: 60vh; }
    .extra-small { font-size: 0.7rem; font-weight: 800; letter-spacing: 0.5px; }
    .btn-indigo { background: #4f46e5; color: white; border: none; transition: 0.3s; }
    .btn-indigo:hover { background: #4338ca; transform: translateY(-2px); box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3); }
    .text-indigo { color: #4f46e5; }
    .btn-outline-indigo { border-color: #4f46e5; color: #4f46e5; transition: 0.3s; }
    .btn-outline-indigo:hover { background: #4f46e5; color: white; }

    /* Uploader Glassmorphism */
    .uploader-container { max-width: 700px; padding: 20px; }
    .uploader-glass { background: #fff; border-radius: 40px; padding: 12px; transition: 0.4s; }
    .uploader-inner-dash { border: 3px dashed #e2e8f0; border-radius: 32px; padding: 60px 20px; }
    .uploader-glass:hover { transform: scale(1.01); box-shadow: 0 30px 60px rgba(0,0,0,0.1); }
    .icon-pulse { width: 80px; height: 80px; border-radius: 50%; margin: 0 auto; display: flex; align-items: center; justify-content: center; font-size: 2rem; box-shadow: 0 0 20px rgba(0,0,0,0.05); }

    /* Workspace */
    .workspace-layout { display: flex; gap: 0; background: #f1f5f9; border-radius: 24px; overflow: hidden; height: 75vh; }
    .gallery-area { flex-grow: 1; background: #f8fafc; position: relative; }
    .side-panel { width: 380px; background: #fff; border-left: 1px solid #e2e8f0; display: flex; align-items: center; }
    .modern-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
    .batch-card { background: #fff; border-radius: 16px; padding: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #eee; text-align: center; }
    .batch-card img { width: 100%; height: 110px; object-fit: contain; border-radius: 8px; margin-bottom: 8px; }
    .batch-card span { font-size: 0.7rem; color: #64748b; font-weight: 600; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    .btn-floating-add { position: absolute; bottom: 30px; right: 30px; width: 60px; height: 60px; background: #4f46e5; color: white; border: none; border-radius: 50%; font-size: 1.5rem; transition: 0.3s; }
    .btn-floating-add:hover { transform: rotate(90deg) scale(1.1); }

    /* Success Components */
    .success-hero-card { border: 1px solid #f1f5f9; }
    .celebration-icon { width: 80px; height: 80px; background: #ecfdf5; color: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-size: 2.5rem; }
    .bg-indigo { background: #4f46e5; }
    .tool-mini-card { transition: 0.2s; background: #fff; }
    .tool-mini-card:hover { border-color: #4f46e5; transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
</style>

<script is:inline>
    // Logic handles the 3-view state system
    const fileInput = document.getElementById('fileInput');
    const viewSelect = document.getElementById('view-select');
    const viewWorkspace = document.getElementById('view-workspace');
    const viewSuccess = document.getElementById('view-success');
    const imageGrid = document.getElementById('imageGrid');
    const btnProcess = document.getElementById('btnProcess');
    
    let filesQueue = [];

    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        viewSelect.style.display = 'none';
        viewWorkspace.style.display = 'flex';

        files.forEach(file => {
            filesQueue.push(file);
            const card = document.createElement('div');
            card.className = 'batch-card fade-in';
            card.innerHTML = `
                <img src="${URL.createObjectURL(file)}">
                <span>${file.name}</span>
            `;
            imageGrid.appendChild(card);
        });
    });

    btnProcess.addEventListener('click', async () => {
        btnProcess.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Optimizing...';
        btnProcess.disabled = true;

        let totalOld = 0;
        let totalNew = 0;
        const zip = new JSZip();

        for (const file of filesQueue) {
            totalOld += file.size;
            try {
                // Aggressive 2026 Engine Logic
                const blob = await imageCompression(file, { maxSizeMB: 0.8, initialQuality: 0.65 });
                totalNew += blob.size;
                zip.file(`zyn-compressed-${file.name}`, blob);
            } catch (err) {
                totalNew += file.size;
            }
        }

        // Stats Calculation
        const savings = Math.max(0, Math.round(((totalOld - totalNew) / totalOld) * 100));
        document.getElementById('statOld').innerText = (totalOld / 1024).toFixed(1) + ' KB';
        document.getElementById('statNew').innerText = (totalNew / 1024).toFixed(1) + ' KB';
        document.getElementById('statSaved').innerText = savings + '%';

        // Prepare Download
        const content = await zip.generateAsync({ type: 'blob' });
        const url = URL.createObjectURL(content);
        const dlBtn = document.getElementById('downloadBtn');
        dlBtn.href = url;
        dlBtn.download = "zyntool-compressed-batch.zip";

        viewWorkspace.style.display = 'none';
        viewSuccess.style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
</script>
