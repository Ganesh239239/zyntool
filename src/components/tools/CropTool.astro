---
const { entry, relatedTools } = Astro.props;
---

<div id="crop-tool">
    <!-- STEP 1: UPLOAD -->
    <div id="uploadContainer" class="uploader-card shadow-lg p-3 mb-5 bg-white">
        <div class="uploader-zone text-center" onclick="document.getElementById('fileInput').click()" style="cursor:pointer">
            <div class="icon-circle mb-3 mx-auto"
                style={`background:${entry.data.color}15;color:${entry.data.color};width:80px;height:80px;border-radius:50%;display:flex;align-items:center;justify-content:center;`}>
                <i class={`fa-solid ${entry.data.icon} fa-3x`}></i>
            </div>
            <h2 class="fw-bold">Select Image to Crop</h2>
            <p class="text-muted small">Crop JPG, PNG or GIF by defining a rectangle.</p>
            <input type="file" id="fileInput" hidden accept="image/*" />
        </div>
    </div>

    <!-- STEP 2: WORKSPACE -->
    <div id="processingArea" style="display:none;" class="fade-in">
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="preview-stage border bg-white rounded-4 overflow-hidden position-relative">
                    <div style="width:100%;height:500px;">
                        <img id="mainPreview" style="max-width:100%;display:block;" />
                    </div>

                    <div id="internalLoader"
                        class="loader-overlay d-none position-absolute top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex flex-column align-items-center justify-content-center text-white">
                        <div class="spinner-border text-primary mb-3"></div>
                        <h5 class="fw-bold">Processing Crop...</h5>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card p-4 shadow-sm rounded-4 sticky-top" style="top:100px;">
                    <h5 class="fw-bold mb-4">Crop Options</h5>

                    <label class="small fw-bold text-muted mb-2">Aspect Ratio</label>
                    <div class="d-grid gap-2 mb-4">
                        <button id="btnFree" class="btn btn-outline-dark btn-sm fw-bold active"
                            onclick="window.setCropRatio(NaN,this)">FREE</button>
                        <button class="btn btn-outline-dark btn-sm fw-bold"
                            onclick="window.setCropRatio(1,this)">1:1</button>
                        <button class="btn btn-outline-dark btn-sm fw-bold"
                            onclick="window.setCropRatio(16/9,this)">16:9</button>
                    </div>

                    <button id="btnAction"
                        class="btn btn-lg w-100 text-white rounded-pill fw-bold py-3 border-0"
                        style={`background:${entry.data.color}`}>
                        Crop Image
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- STEP 3: RESULT -->
    <div id="resultArea" style="display:none;" class="text-center py-5 fade-in">
        <div class="card bg-white mx-auto shadow-lg p-5 rounded-5" style="max-width:600px;">
            <h2 class="fw-bold mb-3">Image Cropped</h2>
            <p class="text-muted mb-4">Your image is ready to download.</p>

            <div class="d-flex gap-2 justify-content-center">
                <a id="downloadBtn" class="btn btn-dark rounded-pill fw-bold px-4 py-2">
                    <i class="fa-solid fa-download me-2"></i>Download
                </a>
                <button class="btn btn-outline-secondary rounded-pill fw-bold px-4 py-2"
                    onclick="location.reload()">
                    Crop Another
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.uploader-card { border-radius:30px;border:1px solid #eee }
.uploader-zone { border:2px dashed #e2e8f0;border-radius:24px;padding:60px 20px }
.preview-stage { min-height:500px;display:flex;align-items:center;justify-content:center }
.btn-outline-dark.active { background:#2c2e33;color:#fff }
</style>

<script is:inline>
let cropper = null;
let originalFile = null;

const fileInput = document.getElementById('fileInput');
const uploadContainer = document.getElementById('uploadContainer');
const processingArea = document.getElementById('processingArea');
const resultArea = document.getElementById('resultArea');
const mainPreview = document.getElementById('mainPreview');
const btnAction = document.getElementById('btnAction');
const internalLoader = document.getElementById('internalLoader');

window.setCropRatio = (ratio, btn) => {
    if (!cropper) return;
    cropper.setAspectRatio(ratio);
    document.querySelectorAll('#crop-tool .btn-outline-dark').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
};

fileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;

    originalFile = file;
    const reader = new FileReader();

    reader.onload = ev => {
        mainPreview.src = ev.target.result;
        uploadContainer.style.display = 'none';
        processingArea.style.display = 'block';

        mainPreview.onload = () => {
            if (cropper) cropper.destroy();

            cropper = new Cropper(mainPreview, {
                viewMode: 1,
                dragMode: 'move',
                autoCropArea: 0.8,
                responsive: true,
                restore: false,
                minCropBoxWidth: 50,
                minCropBoxHeight: 50
            });

            document.getElementById('btnFree').click();
        };
    };

    reader.readAsDataURL(file);
});

btnAction.addEventListener('click', () => {
    if (!cropper) return;

    internalLoader.classList.remove('d-none');
    btnAction.disabled = true;

    try {
        const canvas = cropper.getCroppedCanvas({
            maxWidth: 4096,
            maxHeight: 4096,
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high'
        });

        if (!canvas) throw new Error();

        const isJpg = originalFile.type === 'image/jpeg';
        const mime = isJpg ? 'image/jpeg' : 'image/png';
        const ext = isJpg ? 'jpg' : 'png';

        canvas.toBlob(blob => {
            const url = URL.createObjectURL(blob);
            const dl = document.getElementById('downloadBtn');
            dl.href = url;
            dl.download = `cropped-${Date.now()}.${ext}`;

            internalLoader.classList.add('d-none');
            btnAction.disabled = false;

            processingArea.style.display = 'none';
            resultArea.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }, mime, 0.92);

    } catch {
        internalLoader.classList.add('d-none');
        btnAction.disabled = false;
        alert('Crop failed.');
    }
});
</script>
