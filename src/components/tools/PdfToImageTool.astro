---
import RelatedTools from '../RelatedTools.astro';
const { entry, relatedTools } = Astro.props;
---
<!-- PDF.JS (REQUIRED) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<div id="pdf-to-image-tool">

  <!-- STEP 1: UPLOAD -->
  <div
    id="uploadContainer"
    class="uploader-card shadow-lg mb-5 bg-white mx-auto"
    style="max-width:800px; cursor:pointer;"
  >
    <div class="uploader-border-wrapper p-3">
      <div class="uploader-zone text-center">
        <div
          class="icon-circle mb-3 mx-auto"
          style={`background:${entry.data.color}15;color:${entry.data.color};width:80px;height:80px;border-radius:50%;display:flex;align-items:center;justify-content:center;`}
        >
          <i class={`fa-solid ${entry.data.icon} fa-3x`}></i>
        </div>
        <h2 class="fw-bold text-dark">Select PDF File</h2>
        <p class="text-muted small">Convert PDF pages into individual images.</p>
        <input type="file" id="fileInput" hidden accept="application/pdf" />
      </div>
    </div>
  </div>

  <!-- STEP 2: WORKSPACE -->
  <div id="processingArea" style="display:none;" class="fade-in">
    <div class="row g-4 text-start">

      <!-- LEFT: PREVIEW -->
      <div class="col-lg-8">
        <div class="preview-stage">
          <div class="p-4 bg-light rounded-4 d-inline-block shadow-sm text-center">
            <i class="fa-solid fa-file-pdf fa-4x text-danger mb-3"></i>
            <h5 id="pdfName" class="fw-bold">document.pdf</h5>
            <p id="pdfPages" class="text-muted small mb-0">Detecting pagesâ€¦</p>
          </div>
        </div>
      </div>

      <!-- RIGHT: OPTIONS + RELATED TOOLS -->
      <div class="col-lg-4">

        <div class="card p-4 border-0 shadow-sm rounded-4 bg-white mb-4">
          <h5 class="fw-bold mb-4">Export Options</h5>

          <label class="small fw-bold text-muted mb-2">Image Format</label>
          <select id="imgFmt" class="form-select mb-4">
            <option value="image/jpeg">JPEG (Optimized)</option>
            <option value="image/png">PNG (Lossless)</option>
          </select>

          <button
            id="btnAction"
            class="btn btn-lg w-100 text-white rounded-pill py-3 fw-bold border-0"
            style={`background:${entry.data.color}`}
          >
            Convert PDF
          </button>
        </div>

        <!-- RELATED TOOLS -->
        <RelatedTools relatedTools={relatedTools} />

      </div>
    </div>
  </div>

  <!-- STEP 3: RESULT -->
  <div
    id="resultArea"
    style="display:none;"
    class="text-center py-5 fade-in mx-auto"
  >
    <h3 class="fw-bold mb-4">Extracted Images</h3>
    <div id="imageGridResult" class="row g-3 justify-content-center"></div>
    <button
      class="btn btn-outline-secondary mt-5 rounded-pill px-4 py-2 border-2 fw-bold"
      onclick="location.reload()"
    >
      Process Another PDF
    </button>
  </div>
</div>

<style>
.uploader-card { border-radius:24px; }
.uploader-zone {
  border:3px dashed #cbd5e1;
  border-radius:20px;
  padding:80px 20px;
  transition:0.3s;
  background:#fff;
}
.uploader-zone:hover {
  border-color:#4B90FF;
  background:#f8faff;
}

/* GLOBAL PREVIEW BEHAVIOR */
.preview-stage {
  background:#ffffff;
  border:1px solid #f0f0f0;
  border-radius:24px;
  padding:16px;
  text-align:center;
}
</style>

<script is:inline>
/* PDF.JS WORKER */
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

const root = document.getElementById('pdf-to-image-tool');

const uploadContainer = root.querySelector('#uploadContainer');
const fileInput = root.querySelector('#fileInput');
const processingArea = root.querySelector('#processingArea');
const resultArea = root.querySelector('#resultArea');
const pdfName = root.querySelector('#pdfName');
const pdfPages = root.querySelector('#pdfPages');
const btnAction = root.querySelector('#btnAction');
const imgFmt = root.querySelector('#imgFmt');
const grid = root.querySelector('#imageGridResult');

let pdfDoc = null;

/* MAKE ENTIRE UPLOAD BOX CLICKABLE */
uploadContainer.addEventListener('click', () => {
  fileInput.value = '';
  fileInput.click();
});

/* LOAD PDF */
fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  uploadContainer.style.display = 'none';
  processingArea.style.display = 'block';
  pdfName.textContent = file.name;

  const buffer = await file.arrayBuffer();
  pdfDoc = await pdfjsLib.getDocument(buffer).promise;
  pdfPages.textContent = `${pdfDoc.numPages} pages found`;
});

/* CONVERT */
btnAction.addEventListener('click', async () => {
  if (!pdfDoc) {
    alert('No PDF loaded');
    return;
  }

  processingArea.style.display = 'none';
  resultArea.style.display = 'block';
  grid.innerHTML = '';

  for (let i = 1; i <= pdfDoc.numPages; i++) {
    const page = await pdfDoc.getPage(i);
    const viewport = page.getViewport({ scale: 2 });

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = viewport.width;
    canvas.height = viewport.height;

    await page.render({ canvasContext: ctx, viewport }).promise;

    const mime = imgFmt.value;
    const ext = mime.split('/')[1];
    const url = canvas.toDataURL(mime);

    const col = document.createElement('div');
    col.className = 'col-6 col-md-3';
    col.innerHTML = `
      <div class="card p-2 border-0 shadow-sm rounded-3">
        <img src="${url}" class="img-fluid rounded mb-2">
        <a href="${url}" download="page-${i}.${ext}" class="btn btn-sm btn-dark w-100">
          Download Page ${i}
        </a>
      </div>
    `;
    grid.appendChild(col);
  }
});
</script>
