---
const { entry, relatedTools } = Astro.props;
---
<div id="image-to-pdf-tool">
    <div id="uploadContainer" class="uploader-card shadow-lg p-3 mb-5 bg-white border mx-auto" style="max-width: 800px;">
        <div class="uploader-zone text-center" onclick="document.getElementById('fileInput').click()" style="cursor:pointer">
            <div class="icon-circle mb-3 mx-auto" style={`background: ${entry.data.color}15; color: ${entry.data.color}; width:80px; height:80px; border-radius:50%; display:flex; align-items:center; justify-content:center;`}>
                <i class={`fa-solid ${entry.data.icon} fa-3x`}></i>
            </div>
            <h2 class="fw-bold">Select Images</h2>
            <p class="text-muted small">Convert multiple images into one PDF document.</p>
            <input type="file" id="fileInput" hidden accept="image/*" multiple />
        </div>
    </div>

    <div id="processingArea" style="display:none;" class="fade-in">
        <div class="row g-4 text-start">
            <div class="col-lg-8">
                <div class="preview-stage border bg-light rounded-4 p-4 d-flex flex-wrap gap-2 overflow-auto" style="max-height: 500px;" id="pdfPagePreview">
                    <!-- Thumbnails appear here -->
                </div>
            </div>
            <div class="col-lg-4">
                <div class="options-card card p-4 border-0 shadow-sm rounded-4 bg-white sticky-top" style="top: 100px;">
                    <h5 class="fw-bold mb-4">PDF Settings</h5>
                    <label class="small fw-bold text-muted mb-2">Page Orientation</label>
                    <select id="pdfOrientation" class="form-select mb-3">
                        <option value="p">Portrait</option>
                        <option value="l">Landscape</option>
                    </select>
                    <button id="btnAction" class="btn btn-lg w-100 text-white rounded-pill py-3 fw-bold shadow-sm border-0" style={`background: ${entry.data.color}`}>
                        Convert to PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="resultArea" style="display:none;" class="text-center py-5 fade-in mx-auto" style="max-width: 600px;">
        <div class="result-card card bg-white shadow-lg p-5 rounded-5 border-0">
            <div class="success-badge mb-4" style="width:60px; height:60px; background:#fff1f0; color:#f44336; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto; font-size:1.8rem"><i class="fa-solid fa-file-circle-check"></i></div>
            <h2 class="fw-black mb-3">PDF Created!</h2>
            <a id="downloadBtn" class="btn btn-dark px-5 py-3 rounded-pill fw-bold">Download PDF</a>
        </div>
    </div>
</div>

<script is:inline>
    const fileInput = document.getElementById('fileInput');
    const pdfPagePreview = document.getElementById('pdfPagePreview');
    let images = [];

    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        images = files;
        document.getElementById('uploadContainer').style.display = 'none';
        document.getElementById('processingArea').style.display = 'block';
        
        files.forEach(file => {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.style = "height: 120px; border-radius: 8px; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1)";
            pdfPagePreview.appendChild(img);
        });
    });

    document.getElementById('btnAction').addEventListener('click', async () => {
        const { jsPDF } = window.jspdf;
        const orient = document.getElementById('pdfOrientation').value;
        const doc = new jsPDF(orient, 'px', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        for (let i = 0; i < images.length; i++) {
            if (i > 0) doc.addPage(orient, 'px', 'a4');
            const imgData = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = (ev) => resolve(ev.target.result);
                reader.readAsDataURL(images[i]);
            });
            doc.addImage(imgData, 'JPEG', 20, 20, pageWidth - 40, pageHeight - 40);
        }

        const blob = doc.output('blob');
        document.getElementById('downloadBtn').href = URL.createObjectURL(blob);
        document.getElementById('downloadBtn').download = "zyntool-converted.pdf";
        document.getElementById('processingArea').style.display = 'none';
        document.getElementById('resultArea').style.display = 'block';
    });
</script>
