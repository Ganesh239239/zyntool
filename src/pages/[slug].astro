---
import { getCollection } from 'astro:content';
import MainLayout from '../layouts/MainLayout.astro';

export async function getStaticPaths() {
  const toolEntries = await getCollection('tools');
  return toolEntries.map(entry => ({
    params: { slug: entry.slug || entry.id }, props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const toolId = entry.slug || entry.id;
---

<MainLayout title={entry.data.title}>
    <div class="tool-header py-5 text-white" style={`background-color: ${entry.data.color}`}>
        <div class="container text-center">
            <h1 class="display-4 fw-bold">{entry.data.title}</h1>
            <p class="lead">{entry.data.description}</p>
        </div>
    </div>

    <div class="container my-5">
        <!-- UPLOAD ZONE -->
        <!-- HTML INPUT (Only for HTML to Image tool) -->
        {toolId === 'html-to-image' && (
            <div id="htmlInputArea" class="card p-4 shadow-sm mb-4 border-0 bg-light">
                <label class="fw-bold mb-2">Enter HTML/CSS Code</label>
                <textarea id="htmlCode" class="form-control font-monospace mb-3" rows="8" placeholder="<div style='background: linear-gradient(45deg, #f06, #4a9); color: white; padding: 40px; border-radius: 20px; font-family: sans-serif;'><h1>Hello World</h1><p>This is rendered from HTML!</p></div>"></textarea>
                <button id="btnRenderHtml" class="btn btn-primary">Render Preview</button>
            </div>
        )}

        <!-- UPLOAD ZONE (Hidden if HTML tool is rendering) -->
        <div id="uploadContainer" style={toolId === 'html-to-image' ? "display:none" : ""}>
            <div class="uploader-zone p-5 border-dashed text-center bg-light rounded-4 mb-4" onclick="document.getElementById('fileInput').click()" style="cursor:pointer">
                <i class={`fa-solid ${entry.data.icon} fa-4x mb-3`} style={`color: ${entry.data.color}`}></i>
                <h3>Select Image</h3>
                <p>or drop it here</p>
                <input type="file" id="fileInput" hidden accept="image/*" />
            </div>
        </div>

        <!-- PROCESSING AREA -->
        <div id="processingArea" style="display:none;" class="text-center">
            <div class="preview-card p-4 border rounded shadow-sm mb-4 bg-white">
                <!-- HTML Render Target -->
                <div id="htmlPreviewContainer" style="display:none; margin: 0 auto; display: inline-block;"></div>
                <!-- Image Render Target -->
                <img id="imagePreview" src="" class="img-fluid rounded mb-3" style="max-height: 400px;" />
                
                <div id="optionsPanel" class="p-3 bg-light rounded mb-3 text-start"></div>
                
                <button id="btnAction" class="btn btn-lg w-100 text-white shadow-sm" style={`background-color: ${entry.data.color}`}>
                    Process {entry.data.title}
                </button>
            </div>
        </div>


        <!-- PROCESSING AREA -->
        <div id="processingArea" style="display:none;">
            <div class="row g-4">
                <!-- Left: Preview / Comparison -->
                <div class="col-lg-8">
                    <div class="preview-card p-2 border rounded-4 bg-white shadow-sm overflow-hidden">
                        <div id="comparisonWrapper" class="position-relative" style="display:none;">
                            <img id="imageBefore" src="" class="img-fluid w-100">
                            <div id="comparisonOverlay" class="position-absolute top-0 start-0 h-100 overflow-hidden" style="width: 50%; border-right: 2px solid white;">
                                <img id="imageAfter" src="" class="img-fluid" style="max-width: none;">
                            </div>
                            <input type="range" id="compareSlider" class="position-absolute top-50 start-50 translate-middle w-100 opacity-0" style="z-index: 10; cursor: ew-resize;">
                        </div>
                        <img id="imagePreview" src="" class="img-fluid rounded-3 w-100">
                    </div>
                </div>

                <!-- Right: Premium Options & Batch List -->
                <div class="col-lg-4 text-start">
                    <div class="options-sidebar p-4 border rounded-4 bg-white shadow-sm h-100">
                        <div class="d-flex align-items-center mb-3">
                            <span class="badge bg-warning text-dark me-2">PREMIUM</span>
                            <h5 class="fw-bold m-0">Settings</h5>
                        </div>
                        
                        <div id="optionsPanel" class="mb-4"></div>

                        <div id="batchList" class="mb-4 small text-muted" style="max-height: 150px; overflow-y: auto;">
                            <!-- File names appear here -->
                        </div>

                        <button id="btnAction" class="btn btn-lg w-100 text-white rounded-pill shadow" style={`background-color: ${entry.data.color}`}>
                            Start Processing
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- RESULT AREA (Hidden until processed) -->
        <div id="resultArea" style="display:none;" class="text-center">
            <div class="alert alert-success">Image Processed Successfully!</div>
            <img id="resultImage" src="" class="img-fluid rounded mb-3 border" style="max-height: 400px;" />
            <br />
            <a id="downloadBtn" class="btn btn-dark btn-lg px-5">Download Processed Image</a>
            <br />
            <button class="btn btn-link mt-3" onclick="location.reload()">Process another</button>
        </div>

        <hr class="my-5" />

        <article class="prose mx-auto" style="max-width: 800px;">
            <Content />
        </article>
    </div>

    <!-- CLIENT SIDE SCRIPT -->
  <script is:inline define:vars={{ toolId }}>
    const fileInput = document.getElementById('fileInput');
    const uploadContainer = document.getElementById('uploadContainer');
    const processingArea = document.getElementById('processingArea');
    const imagePreview = document.getElementById('imagePreview');
    const btnAction = document.getElementById('btnAction');
    const optionsPanel = document.getElementById('optionsPanel');
    const batchList = document.getElementById('batchList');
    
    // Comparison Elements
    const comparisonWrapper = document.getElementById('comparisonWrapper');
    const imageBefore = document.getElementById('imageBefore');
    const imageAfter = document.getElementById('imageAfter');
    const comparisonOverlay = document.getElementById('comparisonOverlay');
    const compareSlider = document.getElementById('compareSlider');

    let selectedFiles = [];
    let processedFiles = [];

    // Initialize Options UI (Add Pro Formats)
    if (toolId === 'compress-image') {
        optionsPanel.innerHTML = `
            <label class="fw-bold small d-flex justify-content-between">Quality <span>Recommended</span></label>
            <input type="range" id="compQuality" class="form-range" min="0.1" max="1" step="0.1" value="0.7">
            <label class="fw-bold small mt-3">Export Format</label>
            <select id="exportFormat" class="form-select">
                <option value="image/jpeg">JPEG (Standard)</option>
                <option value="image/webp">WebP (Premium)</option>
                <option value="image/avif">AVIF (Ultra Compressed)</option>
            </select>
        `;
    }

    // MULTI-FILE UPLOAD
    fileInput.setAttribute('multiple', 'true');
    fileInput.addEventListener('change', (e) => {
        selectedFiles = Array.from(e.target.files);
        if (selectedFiles.length > 0) {
            uploadContainer.style.display = 'none';
            processingArea.style.display = 'block';
            
            // Show first image as preview
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imageBefore.src = e.target.result;
            };
            reader.readAsDataURL(selectedFiles[0]);

            // Update Batch List
            batchList.innerHTML = `<p class="fw-bold mb-1">Queue (${selectedFiles.length} files):</p>` + 
                selectedFiles.map(f => `<div>â€¢ ${f.name}</div>`).join('');
        }
    });

    // COMPARISON SLIDER LOGIC
    compareSlider.addEventListener('input', (e) => {
        const value = e.target.value;
        comparisonOverlay.style.width = value + '%';
    });

    // BATCH PROCESSING EXECUTION
    btnAction.addEventListener('click', async () => {
        btnAction.disabled = true;
        btnAction.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Processing...`;
        
        processedFiles = [];

        for (let file of selectedFiles) {
            try {
                let resultBlob;
                if (toolId === 'compress-image') {
                    const quality = parseFloat(document.getElementById('compQuality').value);
                    const format = document.getElementById('exportFormat').value;
                    resultBlob = await imageCompression(file, { 
                        maxSizeMB: 1, 
                        initialQuality: quality,
                        fileType: format 
                    });
                } else {
                    resultBlob = file; // Fallback for other tools
                }
                processedFiles.push({ blob: resultBlob, name: file.name });
            } catch (err) { console.error(err); }
        }

        // Show Comparison for the first file
        if (processedFiles.length > 0) {
            const resultUrl = URL.createObjectURL(processedFiles[0].blob);
            imageAfter.src = resultUrl;
            imagePreview.style.display = 'none';
            comparisonWrapper.style.display = 'block';
            
            // Setup Download
            showResultView();
        }
    });

    function showResultView() {
        document.getElementById('resultArea').style.display = 'block';
        const resultImage = document.getElementById('resultImage');
        const downloadBtn = document.getElementById('downloadBtn');
        
        if (processedFiles.length === 1) {
            const url = URL.createObjectURL(processedFiles[0].blob);
            resultImage.src = url;
            downloadBtn.href = url;
            downloadBtn.innerText = "Download Image";
        } else {
            downloadBtn.innerText = `Download All (${processedFiles.length} files)`;
            downloadBtn.onclick = () => {
                processedFiles.forEach(f => {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(f.blob);
                    a.download = `zyntool-${f.name}`;
                    a.click();
                });
            };
        }
    }
</script>

</Layout>

<style>
    .border-dashed { border: 3px dashed #ccc; transition: 0.3s; }
    .border-dashed:hover { border-color: #4B90FF; background: #f0f7ff !important; }
    .prose h3 { margin-top: 2rem; font-weight: 700; color: #333; }
</style>
