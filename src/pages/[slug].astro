---
import { getCollection } from 'astro:content';
import MainLayout from '../layouts/MainLayout.astro';

export async function getStaticPaths() {
  const toolEntries = await getCollection('tools');
  return toolEntries.map(entry => ({
    params: { slug: entry.slug || entry.id }, props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const toolId = entry.slug || entry.id;
---

<MainLayout title={entry.data.title}>
    <div class="tool-header py-5 text-white" style={`background-color: ${entry.data.color}`}>
        <div class="container text-center">
            <h1 class="display-4 fw-bold">{entry.data.title}</h1>
            <p class="lead">{entry.data.description}</p>
        </div>
    </div>

    <div class="container my-5">
        <!-- UPLOAD ZONE -->
        <!-- HTML INPUT (Only for HTML to Image tool) -->
        {toolId === 'html-to-image' && (
            <div id="htmlInputArea" class="card p-4 shadow-sm mb-4 border-0 bg-light">
                <label class="fw-bold mb-2">Enter HTML/CSS Code</label>
                <textarea id="htmlCode" class="form-control font-monospace mb-3" rows="8" placeholder="<div style='background: linear-gradient(45deg, #f06, #4a9); color: white; padding: 40px; border-radius: 20px; font-family: sans-serif;'><h1>Hello World</h1><p>This is rendered from HTML!</p></div>"></textarea>
                <button id="btnRenderHtml" class="btn btn-primary">Render Preview</button>
            </div>
        )}

        <!-- UPLOAD ZONE (Hidden if HTML tool is rendering) -->
        <div id="uploadContainer" style={toolId === 'html-to-image' ? "display:none" : ""}>
            <div class="uploader-zone p-5 border-dashed text-center bg-light rounded-4 mb-4" onclick="document.getElementById('fileInput').click()" style="cursor:pointer">
                <i class={`fa-solid ${entry.data.icon} fa-4x mb-3`} style={`color: ${entry.data.color}`}></i>
                <h3>Select Image</h3>
                <p>or drop it here</p>
                <input type="file" id="fileInput" hidden accept="image/*" />
            </div>
        </div>

        <!-- PROCESSING AREA -->
        <div id="processingArea" style="display:none;" class="text-center">
            <div class="preview-card p-4 border rounded shadow-sm mb-4 bg-white">
                <!-- HTML Render Target -->
                <div id="htmlPreviewContainer" style="display:none; margin: 0 auto; display: inline-block;"></div>
                <!-- Image Render Target -->
                <img id="imagePreview" src="" class="img-fluid rounded mb-3" style="max-height: 400px;" />
                
                <div id="optionsPanel" class="p-3 bg-light rounded mb-3 text-start"></div>
                
                <button id="btnAction" class="btn btn-lg w-100 text-white shadow-sm" style={`background-color: ${entry.data.color}`}>
                    Process {entry.data.title}
                </button>
            </div>
        </div>

        <!-- PROCESSING AREA (Hidden until file selected) -->
        <div id="processingArea" style="display:none;" class="text-center">
            <div class="preview-card p-4 border rounded shadow-sm mb-4">
                <img id="imagePreview" src="" class="img-fluid rounded mb-3" style="max-height: 400px;" />
                <div id="optionsPanel" class="p-3 bg-light rounded mb-3">
                    <!-- Options for the tool appear here -->
                </div>
                <button id="btnAction" class="btn btn-lg w-100 text-white" style={`background-color: ${entry.data.color}`}>
                    Process {entry.data.title}
                </button>
            </div>
        </div>

        <!-- RESULT AREA (Hidden until processed) -->
        <div id="resultArea" style="display:none;" class="text-center">
            <div class="alert alert-success">Image Processed Successfully!</div>
            <img id="resultImage" src="" class="img-fluid rounded mb-3 border" style="max-height: 400px;" />
            <br />
            <a id="downloadBtn" class="btn btn-dark btn-lg px-5">Download Processed Image</a>
            <br />
            <button class="btn btn-link mt-3" onclick="location.reload()">Process another</button>
        </div>

        <hr class="my-5" />

        <article class="prose mx-auto" style="max-width: 800px;">
            <Content />
        </article>
    </div>

    <!-- CLIENT SIDE SCRIPT -->
   <script is:inline define:vars={{ toolId }}>
    const fileInput = document.getElementById('fileInput');
    const uploadContainer = document.getElementById('uploadContainer');
    const processingArea = document.getElementById('processingArea');
    const imagePreview = document.getElementById('imagePreview');
    const btnAction = document.getElementById('btnAction');
    const optionsPanel = document.getElementById('optionsPanel');
    const resultArea = document.getElementById('resultArea');
    const resultImage = document.getElementById('resultImage');
    const downloadBtn = document.getElementById('downloadBtn');

    let selectedFile = null;
    let cropper = null;

    // 1. TOOL SPECIFIC OPTIONS UI
    if (toolId === 'photo-editor') {
        optionsPanel.innerHTML = `
            <div class="mb-3">
                <label class="form-label small fw-bold">Brightness</label>
                <input type="range" id="bright" class="form-range" min="0" max="200" value="100">
                <label class="form-label small fw-bold">Contrast</label>
                <input type="range" id="cont" class="form-range" min="0" max="200" value="100">
                <label class="form-label small fw-bold">Filter</label>
                <select id="filterSelect" class="form-select form-select-sm">
                    <option value="none">None</option>
                    <option value="grayscale(100%)">Black & White</option>
                    <option value="sepia(100%)">Vintage Sepia</option>
                    <option value="invert(100%)">Invert Colors</option>
                </select>
            </div>`;
    } else if (toolId === 'blur-image') {
        optionsPanel.innerHTML = `<label class="fw-bold small">Blur Intensity</label><input type="range" id="blurVal" class="form-range" min="0" max="30" value="10">`;
    } else if (toolId === 'html-to-image') {
        optionsPanel.innerHTML = `<p class="text-muted small">Ready to capture your HTML as a high-quality image.</p>`;
    }

    // 2. HTML TOOL HANDLER
    if (toolId === 'html-to-image') {
        document.getElementById('btnRenderHtml').addEventListener('click', () => {
            const code = document.getElementById('htmlCode').value;
            const container = document.getElementById('htmlPreviewContainer');
            container.innerHTML = code;
            container.style.display = 'inline-block';
            imagePreview.style.display = 'none';
            processingArea.style.display = 'block';
            document.getElementById('htmlInputArea').style.display = 'none';
        });
    }

    // 3. FILE UPLOAD HANDLER
    if (fileInput) {
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    uploadContainer.style.display = 'none';
                    processingArea.style.display = 'block';
                    if (toolId === 'crop-image') {
                        if(cropper) cropper.destroy();
                        setTimeout(() => { cropper = new Cropper(imagePreview, { viewMode: 1 }); }, 100);
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // 4. MASTER PROCESSING
    btnAction.addEventListener('click', async () => {
        btnAction.disabled = true;
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        try {
            let resultBlob;

            if (toolId === 'html-to-image') {
                const target = document.getElementById('htmlPreviewContainer');
                const htmlCanvas = await html2canvas(target, { backgroundColor: null });
                resultBlob = await new Promise(r => htmlCanvas.toBlob(r, 'image/png'));
            } else if (toolId === 'compress-image') {
                resultBlob = await imageCompression(selectedFile, { maxSizeMB: 1 });
            } else if (toolId === 'crop-image' && cropper) {
                resultBlob = await new Promise(r => cropper.getCroppedCanvas().toBlob(r));
            } else {
                // Image-based canvas tools
                const img = new Image();
                img.src = imagePreview.src;
                await new Promise(r => img.onload = r);
                canvas.width = img.width;
                canvas.height = img.height;

                if (toolId === 'photo-editor') {
                    const b = document.getElementById('bright').value;
                    const c = document.getElementById('cont').value;
                    const f = document.getElementById('filterSelect').value;
                    ctx.filter = `brightness(${b}%) contrast(${c}%) ${f !== 'none' ? f : ''}`;
                    ctx.drawImage(img, 0, 0);
                } else if (toolId === 'blur-image') {
                    const val = document.getElementById('blurVal').value;
                    ctx.filter = `blur(${val}px)`;
                    ctx.drawImage(img, 0, 0);
                } else {
                    ctx.drawImage(img, 0, 0);
                }
                resultBlob = await new Promise(r => canvas.toBlob(r, 'image/png'));
            }

            const url = URL.createObjectURL(resultBlob);
            resultImage.src = url;
            downloadBtn.href = url;
            downloadBtn.download = `zyntool-${toolId}.png`;
            processingArea.style.display = 'none';
            resultArea.style.display = 'block';
        } catch (err) {
            console.error(err);
            alert("Error processing image.");
        } finally {
            btnAction.disabled = false;
        }
    });
</script>
</Layout>

<style>
    .border-dashed { border: 3px dashed #ccc; transition: 0.3s; }
    .border-dashed:hover { border-color: #4B90FF; background: #f0f7ff !important; }
    .prose h3 { margin-top: 2rem; font-weight: 700; color: #333; }
</style>
