---
import { getCollection } from 'astro:content';
import MainLayout from '../layouts/MainLayout.astro';

export async function getStaticPaths() {
  const toolEntries = await getCollection('tools');
  
  // If no tools are found, return an empty array to prevent crash
  if (!toolEntries || toolEntries.length === 0) return [];

  return toolEntries.map(entry => ({
    params: { slug: entry.slug || entry.id }, 
    props: { entry },
  }));
}

const { entry } = Astro.props;

// SAFETY CHECK: If entry is undefined, redirect or show error
if (!entry) {
  return Astro.redirect('/404');
}

const { Content } = await entry.render();
const toolId = entry.slug || entry.id;
---

<MainLayout title={entry.data.title}>
    <div class="tool-header py-5 text-white" style={`background-color: ${entry.data.color}`}>
        <div class="container text-center">
            <h1 class="display-4 fw-bold">{entry.data.title}</h1>
            <p class="lead">{entry.data.description}</p>
        </div>
    </div>

    <div class="container my-5">
        <div id="uploadContainer">
            <div class="uploader-zone p-5 border-dashed text-center bg-light rounded-4 mb-4" onclick="document.getElementById('fileInput').click()" style="cursor:pointer">
                <i class={`fa-solid ${entry.data.icon} fa-4x mb-3`} style={`color: ${entry.data.color}`}></i>
                <h3>Select Image</h3>
                <p>or drop it here</p>
                <input type="file" id="fileInput" hidden accept="image/*" />
            </div>
        </div>

        <div id="processingArea" style="display:none;" class="text-center">
            <div class="preview-card p-4 border rounded shadow-sm mb-4 bg-white">
                <img id="mainPreview" src="" class="img-fluid rounded mb-3" style="max-height: 400px;" />
                <div id="optionsPanel" class="p-3 bg-light rounded mb-3 text-start"></div>
                <button id="btnAction" class="btn btn-lg w-100 text-white shadow-sm" style={`background-color: ${entry.data.color}`}>
                    Process {entry.data.title}
                </button>
            </div>
        </div>

        <div id="resultArea" style="display:none;" class="text-center py-5">
            <div class="card border-0 shadow-lg rounded-5 p-5 mx-auto" style="max-width: 500px;">
                <div class="text-success mb-4"><i class="fa-solid fa-circle-check fa-5x"></i></div>
                <h2 class="fw-bold">Ready!</h2>
                <div class="d-grid gap-2 mt-4">
                    <a id="downloadBtn" class="btn btn-dark btn-lg py-3 rounded-3 fw-bold">Download Now</a>
                    <button class="btn btn-outline-secondary py-2 rounded-3 fw-bold" onclick="location.reload()">Reset Tool</button>
                </div>
            </div>
        </div>

        <hr class="my-5" />
        <article class="prose mx-auto" style="max-width: 800px;">
            <Content />
        </article>
    </div>

    <script is:inline define:vars={{ toolId }}>
        // Your existing JS logic here... (Keep the scripts we wrote in Step 17/19)
        const fileInput = document.getElementById('fileInput');
        const uploadContainer = document.getElementById('uploadContainer');
        const processingArea = document.getElementById('processingArea');
        const mainPreview = document.getElementById('mainPreview');
        const btnAction = document.getElementById('btnAction');
        const optionsPanel = document.getElementById('optionsPanel');

        // Simple check to ensure scripts run
        if (fileInput) {
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        mainPreview.src = ev.target.result;
                        uploadContainer.style.display = 'none';
                        processingArea.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        btnAction.addEventListener('click', () => {
             // For now, let's just show the result area to confirm it works
             document.getElementById('processingArea').style.display = 'none';
             document.getElementById('resultArea').style.display = 'block';
        });
    </script>
</MainLayout>

<style>
    .border-dashed { border: 3px dashed #cbd5e0; border-radius: 20px; transition: 0.3s; background: #fff; }
    .mt-n5 { margin-top: -4rem !important; }
</style>
