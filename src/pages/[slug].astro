<script is:inline define:vars={{ toolId }}>
    // --- SHARED ELEMENTS ---
    const fileInput = document.getElementById('fileInput');
    const uploadContainer = document.getElementById('uploadContainer');
    const processingArea = document.getElementById('processingArea');
    const optionsPanel = document.getElementById('optionsPanel');
    const btnAction = document.getElementById('btnAction');
    const internalLoader = document.getElementById('internalLoader');
    const resultArea = document.getElementById('resultArea');
    const mainPreview = document.getElementById('mainPreview');
    const htmlRenderArea = document.getElementById('htmlRenderArea');

    let originalFile = null;
    let cropper = null;

    // --- TOOL-SPECIFIC ENGINES (This separates the logic) ---
    const ToolRegistry = {
        'compress-image': {
            renderUI: () => {
                optionsPanel.innerHTML = `
                    <label class="fw-bold small d-flex justify-content-between">Quality <span id="qVal">70%</span></label>
                    <input type="range" id="qIn" class="form-range" min="0.1" max="1" step="0.1" value="0.7">
                    <label class="fw-bold small mt-3">Format</label>
                    <select id="fIn" class="form-select"><option value="image/jpeg">JPG</option><option value="image/webp">WebP</option></select>
                `;
                document.getElementById('qIn').oninput = (e) => document.getElementById('qVal').innerText = Math.round(e.target.value * 100) + '%';
            },
            process: async () => {
                const q = parseFloat(document.getElementById('qIn').value);
                const f = document.getElementById('fIn').value;
                const blob = await imageCompression(originalFile, { maxSizeMB: 1, initialQuality: q, fileType: f });
                return { blob, ext: f.split('/')[1] };
            }
        },
        'resize-image': {
            renderUI: () => {
                optionsPanel.innerHTML = `
                    <label class="small fw-bold">Width (px)</label>
                    <input type="number" id="wIn" class="form-control mb-3" value="1200">
                    <div class="form-check form-switch small"><input class="form-check-input" type="checkbox" checked id="ratioLock"><label>Lock Aspect Ratio</label></div>
                `;
            },
            process: async () => {
                const w = parseInt(document.getElementById('wIn').value);
                const blob = await imageCompression(originalFile, { maxWidthOrHeight: w });
                return { blob, ext: 'png' };
            }
        },
        'crop-image': {
            renderUI: () => {
                optionsPanel.innerHTML = `<p class="alert alert-info small">Drag the box on the preview to select your area.</p>`;
            },
            process: async () => {
                const canvas = cropper.getCroppedCanvas();
                const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
                return { blob, ext: 'png' };
            }
        },
        'html-to-image': {
            renderUI: () => {
                optionsPanel.innerHTML = `<p class="text-muted small">Rendering HTML to high-quality PNG.</p>`;
            },
            process: async () => {
                const canvas = await html2canvas(htmlRenderArea);
                const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
                return { blob, ext: 'png' };
            }
        }
    };

    // --- INITIALIZE CURRENT TOOL ---
    const currentTool = ToolRegistry[toolId] || { 
        renderUI: () => { optionsPanel.innerHTML = '<p class="text-muted small">Standard processing applied.</p>'; },
        process: async () => { return { blob: originalFile, ext: 'png' }; }
    };
    currentTool.renderUI();

    // --- COMMON HELPERS ---
    window.renderHTML = () => {
        const code = document.getElementById('htmlInput').value;
        if(!code) return alert("Enter HTML first");
        htmlRenderArea.innerHTML = code;
        htmlRenderArea.style.display = 'block';
        mainPreview.style.display = 'none';
        uploadContainer.style.display = 'none';
        processingArea.style.display = 'block';
    };

    // --- UPLOAD LOGIC ---
    if(fileInput) {
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                originalFile = file;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    mainPreview.src = ev.target.result;
                    uploadContainer.style.display = 'none';
                    processingArea.style.display = 'block';
                    // Specific behavior for Crop
                    if (toolId === 'crop-image') {
                        if (cropper) cropper.destroy();
                        setTimeout(() => { cropper = new Cropper(mainPreview, { viewMode: 1, autoCropArea: 0.8 }); }, 200);
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // --- FINAL PROCESSING LOGIC ---
    btnAction.addEventListener('click', async () => {
        internalLoader.classList.remove('d-none');
        btnAction.disabled = true;

        try {
            // Run ONLY the current tool's process function
            const result = await currentTool.process();
            
            // Stats handling (Only for Compress)
            if (toolId === 'compress-image' && window.formatBytes) {
                document.getElementById('savingsStats').style.display = 'flex';
                document.getElementById('oldSizeLabel').innerText = formatBytes(originalFile.size);
                document.getElementById('newSizeLabel').innerText = formatBytes(result.blob.size);
                document.getElementById('percentLabel').innerText = Math.round(((originalFile.size - result.blob.size)/originalFile.size)*100) + '%';
            }

            const url = URL.createObjectURL(result.blob);
            document.getElementById('downloadBtn').href = url;
            document.getElementById('downloadBtn').download = `zyntool-${Date.now()}.${result.ext}`;
            
            setTimeout(() => {
                processingArea.style.display = 'none';
                resultArea.style.display = 'block';
            }, 800);
        } catch (e) {
            console.error(e);
            alert("Error processing image.");
            internalLoader.classList.add('d-none');
            btnAction.disabled = false;
        }
    });
</script>
