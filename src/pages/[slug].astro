---
import { getCollection } from 'astro:content';
import MainLayout from '../layouts/MainLayout.astro';

// Import all modular tool components
import CompressTool from '../components/tools/CompressTool.astro';
import ResizeTool from '../components/tools/ResizeTool.astro';
import CropTool from '../components/tools/CropTool.astro';
import WatermarkTool from '../components/tools/WatermarkTool.astro';
import BlurTool from '../components/tools/BlurTool.astro';
import ConvertFromJpgTool from '../components/tools/ConvertFromJpgTool.astro';
import ConvertToJpgTool from '../components/tools/ConvertToJpgTool.astro';
import MemeTool from '../components/tools/MemeTool.astro';
import HtmlToImageTool from '../components/tools/HtmlToImageTool.astro';
import UpscaleTool from '../components/tools/UpscaleTool.astro';
import RemoveBgTool from '../components/tools/RemoveBgTool.astro';
import PhotoEditorTool from '../components/tools/PhotoEditorTool.astro';
import ImageToPdfTool from '../components/tools/ImageToPdfTool.astro';
import PdfToImageTool from '../components/tools/PdfToImageTool.astro';
import OcrTool from '../components/tools/OcrTool.astro';

export async function getStaticPaths() {
  const toolEntries = await getCollection('tools');
  if (!toolEntries || toolEntries.length === 0) return [];
  
  return toolEntries.map(entry => ({
    params: { slug: entry.slug || entry.id }, 
    props: { entry },
  }));
}

const { entry } = Astro.props;

// BUILD SAFETY: Prevent crash if prop is missing
if (!entry) {
  return Astro.redirect('/404');
}

// 1. Fetch Related Tools for Sidebar
const allTools = await getCollection('tools');
const toolId = entry.slug || entry.id;
const relatedTools = allTools
  .filter(t => (t.slug || t.id) !== toolId)
  .slice(0, 6);

// 2. SEO Content Generation
const seoTitle = entry.data.seo_title || `${entry.data.title} Online - 100% Free | ZynTool`;
const seoDesc = entry.data.seo_description || `Process your images locally with our ${entry.data.title} tool. Fast, private, and secure.`;

// 3. Render Markdown Content
const { Content } = await entry.render();
---

<MainLayout title={seoTitle} description={seoDesc}>
    <!-- APP-STYLE BREADCRUMB HEADER (Developer Design) -->
    <div class="app-breadcrumb-bar border-bottom bg-white">
        <div class="container d-flex align-items-center justify-content-between h-100">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb m-0">
                    <li class="breadcrumb-item"><a href="/" class="text-decoration-none text-muted small fw-bold">Home</a></li>
                    <li class="breadcrumb-item active small fw-bold text-dark" aria-current="page">{entry.data.title}</li>
                </ol>
            </nav>

            <div class="d-none d-md-flex align-items-center gap-2">
                <span class="pulse-dot"></span>
                <span class="extra-small fw-bold text-muted uppercase">Browser Engine Active</span>
            </div>
        </div>
    </div>

    <div class="container py-4">
        <!-- THE TOOL WORKSPACE -->
        <div class="tool-main-stage mb-5">
            {toolId === 'compress-image' && <CompressTool entry={entry} relatedTools={relatedTools} />}
            {toolId === 'resize-image' && <ResizeTool entry={entry} relatedTools={relatedTools} />}
            {toolId === 'crop-image' && <CropTool entry={entry} relatedTools={relatedTools} />}
            {toolId === 'watermark-image' && <WatermarkTool entry={entry} relatedTools={relatedTools} />}
            {toolId === 'blur-image' && <BlurTool entry={entry} relatedTools={relatedTools} />}
            {toolId === 'convert-from-jpg' && <ConvertFromJpgTool entry={entry} relatedTools={relatedTools} />}
            {toolId === 'convert-to-jpg' && <ConvertToJpgTool entry={entry} relatedTools={relatedTools} />}
            {toolId === 'meme-generator' && <MemeTool entry={entry} relatedTools={relatedTools} />}
            {toolId === 'html-to-image' && <HtmlToImageTool entry={entry} relatedTools={relatedTools} />}
            {toolId === 'upscale-image' && <UpscaleTool entry={entry} relatedTools={relatedTools} />}
            {toolId === 'remove-background' && <RemoveBgTool entry={entry} relatedTools={relatedTools} />}
            {toolId === 'photo-editor' && <PhotoEditorTool entry={entry} relatedTools={relatedTools} />}
            {toolId === 'image-to-pdf' && <ImageToPdfTool entry={entry} relatedTools={relatedTools} />}
            {toolId === 'pdf-to-image' && <PdfToImageTool entry={entry} relatedTools={relatedTools} />}
            {toolId === 'ocr-image' && <OcrTool entry={entry} relatedTools={relatedTools} />}
        </div>

        <!-- DOCUMENTATION SECTION -->
        <div class="content-section pt-5 border-top">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <header class="mb-4">
                        <h2 class="fw-bold h4">Manual & Technical Guide</h2>
                        <p class="text-muted small">Everything you need to know about using our {entry.data.title} tool.</p>
                    </header>
                    <article class="prose">
                        <Content />
                    </article>
                </div>
            </div>
        </div>
    </div>
</MainLayout>

<style>
    /* UTILITY HEADER STYLES */
    .app-breadcrumb-bar {
        height: 50px;
        position: sticky;
        top: 70px;
        z-index: 100;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        content: "â€º";
        color: #cbd5e1;
        font-size: 1.2rem;
        vertical-align: middle;
    }

    .extra-small { font-size: 0.65rem; letter-spacing: 0.5px; }

    /* PULSE INDICATOR */
    .pulse-dot {
        width: 8px; height: 8px;
        background-color: #10b981;
        border-radius: 50%;
        animation: pulse-green 2s infinite;
    }

    @keyframes pulse-green {
        0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
        100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }

    /* TYPOGRAPHY */
    .prose { 
        max-width: 100%;
        color: #334155; 
        line-height: 1.7;
    }
    .prose :global(h2) { font-size: 1.5rem; font-weight: 700; color: #0f172a; margin-top: 2rem; }
    .prose :global(h3) { font-size: 1.25rem; font-weight: 700; color: #0f172a; margin-top: 1.5rem; }
    .prose :global(p) { margin-bottom: 1.25rem; }

    @media (max-width: 767px) {
        .app-breadcrumb-bar { height: 45px; }
    }
</style>
