---
import { getCollection } from 'astro:content';
import MainLayout from '../layouts/MainLayout.astro';

export async function getStaticPaths() {
  const toolEntries = await getCollection('tools');
  return toolEntries.map(entry => ({
    params: { slug: entry.slug || entry.id }, props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const toolId = entry.slug || entry.id;
---

<MainLayout title={entry.data.title}>
    <div class="tool-header py-5 text-white" style={`background-color: ${entry.data.color}`}>
        <div class="container text-center">
            <h1 class="display-4 fw-bold">{entry.data.title}</h1>
            <p class="lead">{entry.data.description}</p>
        </div>
    </div>

    <div class="container my-5">
        <!-- UPLOAD ZONE -->
        <div id="uploadContainer">
            <div class="uploader-zone p-5 border-dashed text-center bg-light rounded-4 mb-4" onclick="document.getElementById('fileInput').click()" style="cursor:pointer">
                <i class={`fa-solid ${entry.data.icon} fa-4x mb-3`} style={`color: ${entry.data.color}`}></i>
                <h3>Select Images</h3>
                <p>or drop them here</p>
                <input type="file" id="fileInput" hidden accept="image/*" />
            </div>
        </div>

        <!-- PROCESSING AREA (Hidden until file selected) -->
        <div id="processingArea" style="display:none;" class="text-center">
            <div class="preview-card p-4 border rounded shadow-sm mb-4">
                <img id="imagePreview" src="" class="img-fluid rounded mb-3" style="max-height: 400px;" />
                <div id="optionsPanel" class="p-3 bg-light rounded mb-3">
                    <!-- Options for the tool appear here -->
                </div>
                <button id="btnAction" class="btn btn-lg w-100 text-white" style={`background-color: ${entry.data.color}`}>
                    Process {entry.data.title}
                </button>
            </div>
        </div>

        <!-- RESULT AREA (Hidden until processed) -->
        <div id="resultArea" style="display:none;" class="text-center">
            <div class="alert alert-success">Image Processed Successfully!</div>
            <img id="resultImage" src="" class="img-fluid rounded mb-3 border" style="max-height: 400px;" />
            <br />
            <a id="downloadBtn" class="btn btn-dark btn-lg px-5">Download Processed Image</a>
            <br />
            <button class="btn btn-link mt-3" onclick="location.reload()">Process another</button>
        </div>

        <hr class="my-5" />

        <article class="prose mx-auto" style="max-width: 800px;">
            <Content />
        </article>
    </div>

    <!-- CLIENT SIDE SCRIPT -->
    <script is:inline define:vars={{ toolId }}>
        const fileInput = document.getElementById('fileInput');
        const uploadContainer = document.getElementById('uploadContainer');
        const processingArea = document.getElementById('processingArea');
        const imagePreview = document.getElementById('imagePreview');
        const btnAction = document.getElementById('btnAction');
        const resultArea = document.getElementById('resultArea');
        const resultImage = document.getElementById('resultImage');
        const downloadBtn = document.getElementById('downloadBtn');

        let selectedFile = null;

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    uploadContainer.style.display = 'none';
                    processingArea.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        btnAction.addEventListener('click', async () => {
            btnAction.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
            btnAction.disabled = true;

            try {
                let resultBlob;
                
                // LOGIC BASED ON THE TOOL TYPE
                if (toolId === 'compress-image') {
                    resultBlob = await imageCompression(selectedFile, { maxSizeMB: 1, initialQuality: 0.6 });
                } else {
                    // Default fallback (just returns the file)
                    resultBlob = selectedFile;
                }

                const url = URL.createObjectURL(resultBlob);
                resultImage.src = url;
                downloadBtn.href = url;
                downloadBtn.download = `processed-${selectedFile.name}`;
                
                processingArea.style.display = 'none';
                resultArea.style.display = 'block';
            } catch (err) {
                alert('Error processing image');
                console.error(err);
            }
        });
    </script>
</Layout>

<style>
    .border-dashed { border: 3px dashed #ccc; transition: 0.3s; }
    .border-dashed:hover { border-color: #4B90FF; background: #f0f7ff !important; }
    .prose h3 { margin-top: 2rem; font-weight: 700; color: #333; }
</style>
